<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I.R.I.S. Settings</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/x-icon" href="/assets/fav.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/settings.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    colors: {
                        iris: { bg: '#0a0a0f', panel: '#12121a', card: '#1a1a24', border: 'rgba(255, 255, 255, 0.08)', accent: '#8b5cf6', accentLight: '#a78bfa' }
                    }
                }
            }
        }
    </script>
</head>
<body class="text-sm selection:bg-purple-500/30 selection:text-purple-100">
    <div class="flex h-screen w-full overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-[320px] lg:w-[360px] flex flex-col bg-iris-panel border-r border-iris-border flex-shrink-0 z-20">
            <!-- Logo Header -->
            <div class="h-14 flex items-center justify-between px-4 border-b border-iris-border">
                <a href="/" class="flex items-center gap-2.5 group">
                    <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-violet-500 via-purple-500 to-indigo-600 flex items-center justify-center shadow-lg shadow-purple-500/20">
                        <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                    </div>
                    <div>
                        <h1 class="font-bold text-base tracking-tight text-white leading-none">I.R.I.S.</h1>
                        <span class="text-[9px] font-mono text-purple-400/80 tracking-widest">AI STUDIO</span>
                    </div>
                </a>
                <div class="flex items-center gap-1">
                    <span id="gpuStatusDot" class="w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.6)]"></span>
                    <span id="gpuStatusText" class="text-[10px] font-medium text-zinc-500">Ready</span>
                </div>
            </div>
            <!-- Navigation -->
            <nav class="px-3 py-2 border-b border-iris-border">
                <div class="flex gap-1 p-1 bg-iris-bg/50 rounded-lg">
                    <a href="/" class="flex-1 px-3 py-1.5 text-center text-[11px] font-medium rounded-md text-zinc-400 hover:text-white hover:bg-white/5 transition-all">Home</a>
                    <a href="/generate" class="flex-1 px-3 py-1.5 text-center text-[11px] font-medium rounded-md text-zinc-400 hover:text-white hover:bg-white/5 transition-all">Create</a>
                    <a href="/gallery" class="flex-1 px-3 py-1.5 text-center text-[11px] font-medium rounded-md text-zinc-400 hover:text-white hover:bg-white/5 transition-all">Gallery</a>
                    <span class="flex-1 px-3 py-1.5 text-center text-[11px] font-medium rounded-md bg-iris-accent/20 text-iris-accentLight border border-iris-accent/30">Settings</span>
                </div>
            </nav>
            <!-- Sidebar Content - Quick Stats -->
            <div class="flex-1 overflow-y-auto custom-scrollbar">
                <div class="p-4 space-y-4">
                    <div class="text-[10px] text-zinc-500 uppercase font-semibold tracking-wider">Quick Stats</div>
                    <div class="space-y-3">
                        <div class="p-3 bg-iris-card rounded-xl border border-iris-border">
                            <div class="text-[10px] text-zinc-500 uppercase mb-1">GPU Load</div>
                            <div class="text-xl font-bold text-white font-mono" id="gpuLoad">0%</div>
                            <div class="w-full bg-black/30 h-1.5 rounded-full mt-2 overflow-hidden">
                                <div id="gpuBar" class="h-full rounded-full transition-all" style="width: 0%; background: linear-gradient(90deg, #8b5cf6, #a78bfa)"></div>
                            </div>
                        </div>
                        <div class="p-3 bg-iris-card rounded-xl border border-iris-border">
                            <div class="text-[10px] text-zinc-500 uppercase mb-1">VRAM</div>
                            <div class="text-xl font-bold text-white font-mono"><span id="vramUsed">0</span> / <span id="vramTotal">0</span> GB</div>
                            <div class="w-full bg-black/30 h-1.5 rounded-full mt-2 overflow-hidden">
                                <div id="vramBar" class="h-full rounded-full transition-all" style="width: 0%; background: linear-gradient(90deg, #6366f1, #818cf8)"></div>
                            </div>
                        </div>
                        <div class="p-3 bg-iris-card rounded-xl border border-iris-border">
                            <div class="text-[10px] text-zinc-500 uppercase mb-1">Library</div>
                            <div class="text-xl font-bold text-white font-mono" id="statImages">0 images</div>
                            <div class="text-xs text-zinc-500 mt-1" id="statStorage">0 MB used</div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Save Button -->
            <div class="p-4 border-t border-iris-border bg-iris-panel">
                <button onclick="saveAllSettings()" class="w-full py-3.5 rounded-xl bg-iris-accent hover:bg-iris-accent/80 text-white text-sm font-bold flex items-center justify-center gap-2 transition-all">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                    <span id="saveButtonText">Save Settings</span>
                </button>
            </div>
        </aside>
        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto bg-iris-bg">
            <div class="max-w-4xl mx-auto p-8">
                <header class="mb-8">
                    <h1 class="text-2xl font-bold text-white mb-2">System Settings</h1>
                    <p class="text-zinc-500 text-sm">Manage your hardware resources and system configurations.</p>
                </header>
                <div class="space-y-6">
                    <!-- Generation Settings -->
                    <section class="glass-panel liquid-glass p-6 rounded-2xl">
                        <h2 class="text-base font-bold text-white mb-5 flex items-center gap-2">
                            <svg class="w-5 h-5 text-iris-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                            Generation Settings
                        </h2>
                        <div class="space-y-5">
                            <!-- Compute Device -->
                            <div class="p-4 bg-iris-card rounded-xl border border-iris-border">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-lg bg-purple-500/10 flex items-center justify-center">
                                            <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/></svg>
                                        </div>
                                        <div>
                                            <div class="text-sm font-medium text-white">Compute Device</div>
                                            <div class="text-xs text-zinc-500">Select GPU or CPU for generation</div>
                                        </div>
                                    </div>
                                    <span id="deviceSwitchStatus" class="text-xs text-zinc-500"></span>
                                </div>
                                <div class="flex flex-wrap gap-2" id="deviceButtons">
                                    <!-- Buttons will be dynamically generated -->
                                </div>
                                <div id="deviceInfo" class="mt-3 text-[10px] text-zinc-500"></div>
                            </div>
                            <!-- DRAM Extension -->
                            <div class="flex items-center justify-between p-4 bg-iris-card rounded-xl border border-iris-border">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-lg bg-blue-500/10 flex items-center justify-center">
                                        <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/></svg>
                                    </div>
                                    <div>
                                        <div class="text-sm font-medium text-white">DRAM Extension</div>
                                        <div class="text-xs text-zinc-500">Use system RAM as VRAM fallback</div>
                                    </div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="dramExtensionToggle" class="sr-only peer" onchange="toggleDramExtension()">
                                    <div class="w-11 h-6 bg-zinc-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-iris-accent"></div>
                                </label>
                            </div>
                            <!-- DRAM Settings -->
                            <div id="dramSettings" class="hidden pl-4 border-l-2 border-iris-accent/30 space-y-4">
                                <div>
                                    <div class="flex justify-between mb-2">
                                        <label class="text-xs text-zinc-400">VRAM Threshold</label>
                                        <span id="vramThresholdValue" class="text-xs font-mono text-iris-accent">6 GB</span>
                                    </div>
                                    <input type="range" id="vramThresholdSlider" min="2" max="12" value="6" step="1" class="w-full" oninput="updateVramThreshold(this.value)">
                                    <div class="text-[10px] text-zinc-600 mt-1">Enable DRAM extension when VRAM is below this threshold</div>
                                </div>
                                <div>
                                    <div class="flex justify-between mb-2">
                                        <label class="text-xs text-zinc-400">Max DRAM Usage</label>
                                        <span id="maxDramValue" class="text-xs font-mono text-iris-accent">16 GB</span>
                                    </div>
                                    <input type="range" id="maxDramSlider" min="4" max="64" value="16" step="4" class="w-full" oninput="updateMaxDram(this.value)">
                                    <div class="text-[10px] text-zinc-600 mt-1">Maximum system RAM to use for model offloading</div>
                                </div>
                            </div>
                            <!-- NSFW Filter -->
                            <div class="p-4 bg-iris-card rounded-xl border border-iris-border">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-lg bg-red-500/10 flex items-center justify-center">
                                            <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                                        </div>
                                        <div>
                                            <div class="text-sm font-medium text-white">NSFW Content Filter</div>
                                            <div class="text-xs text-zinc-500">Block explicit content in prompts</div>
                                        </div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="nsfwFilterToggle" class="sr-only peer" checked onchange="toggleNsfwFilter()">
                                        <div class="w-11 h-6 bg-zinc-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-500"></div>
                                    </label>
                                </div>
                                <div id="nsfwFilterSettings">
                                    <div class="flex justify-between mb-2">
                                        <label class="text-xs text-zinc-400">Filter Strength</label>
                                        <span id="nsfwStrengthValue" class="text-xs font-mono text-iris-accent">Standard</span>
                                    </div>
                                    <input type="range" id="nsfwStrengthSlider" min="1" max="3" value="2" step="1" class="w-full" oninput="updateNsfwStrength(this.value)">
                                    <div class="flex justify-between text-[10px] text-zinc-600 mt-1">
                                        <span>Relaxed</span>
                                        <span>Standard</span>
                                        <span>Strict</span>
                                    </div>
                                </div>
                                <div id="nsfwFilterWarning" class="hidden mt-3 flex items-center gap-2 p-3 bg-amber-500/10 border border-amber-500/30 rounded-lg">
                                    <svg class="w-4 h-4 text-amber-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                                    <span class="text-xs text-amber-300">Research Mode - Filter disabled for testing</span>
                                </div>
                            </div>
                        </div>
                    </section>
                    <!-- Hardware Status -->
                    <section class="glass-panel liquid-glass p-6 rounded-2xl">
                        <h2 class="text-base font-bold text-white mb-5 flex items-center gap-2">
                            <svg class="w-5 h-5 text-iris-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/></svg>
                            Hardware Monitoring
                        </h2>
                        <div class="grid md:grid-cols-2 gap-4">
                            <!-- GPU Usage -->
                            <div class="p-4 bg-iris-card rounded-xl border border-iris-border">
                                <div class="text-[10px] text-zinc-400 uppercase font-semibold mb-1 tracking-wider">GPU Usage</div>
                                <div class="flex items-end justify-between">
                                    <div class="text-2xl font-bold text-white font-mono" id="gpuLoadMain">0%</div>
                                    <div class="text-sm text-iris-accentLight font-mono" id="gpuTemp">--°C</div>
                                </div>
                                <div class="w-full bg-black/30 h-2 rounded-full mt-3 overflow-hidden border border-white/5">
                                    <div id="gpuBarMain" class="h-full rounded-full transition-all duration-500" style="width: 0%; background: linear-gradient(90deg, #8b5cf6, #a78bfa);"></div>
                                </div>
                                <div class="flex justify-between mt-2 text-[10px] text-zinc-500">
                                    <span id="gpuPower">-- W</span>
                                    <span id="gpuName">--</span>
                                </div>
                            </div>
                            <!-- VRAM Usage -->
                            <div class="p-4 bg-iris-card rounded-xl border border-iris-border">
                                <div class="text-[10px] text-zinc-400 uppercase font-semibold mb-1 tracking-wider">VRAM Usage</div>
                                <div class="flex items-end justify-between">
                                    <div class="text-2xl font-bold text-white font-mono" id="vramUsedMain">-- GB</div>
                                    <div class="text-sm text-zinc-500" id="vramTotalMain">/ -- GB</div>
                                </div>
                                <div class="w-full bg-black/30 h-2 rounded-full mt-3 overflow-hidden border border-white/5">
                                    <div id="vramBarMain" class="h-full rounded-full transition-all duration-500" style="width: 0%; background: linear-gradient(90deg, #6366f1, #818cf8);"></div>
                                </div>
                            </div>
                            <!-- CPU Usage -->
                            <div class="p-4 bg-iris-card rounded-xl border border-iris-border">
                                <div class="text-[10px] text-zinc-400 uppercase font-semibold mb-1 tracking-wider">CPU Usage</div>
                                <div class="flex items-end justify-between">
                                    <div class="text-2xl font-bold text-white font-mono" id="cpuLoadMain">0%</div>
                                    <div class="text-sm text-zinc-500 font-mono" id="cpuFreq">-- GHz</div>
                                </div>
                                <div class="w-full bg-black/30 h-2 rounded-full mt-3 overflow-hidden border border-white/5">
                                    <div id="cpuBarMain" class="h-full rounded-full transition-all duration-500" style="width: 0%; background: linear-gradient(90deg, #10b981, #34d399);"></div>
                                </div>
                                <div class="flex justify-between mt-2 text-[10px] text-zinc-500">
                                    <span id="cpuCores">-- Cores</span>
                                </div>
                            </div>
                            <!-- RAM Usage -->
                            <div class="p-4 bg-iris-card rounded-xl border border-iris-border">
                                <div class="text-[10px] text-zinc-400 uppercase font-semibold mb-1 tracking-wider">RAM Usage</div>
                                <div class="flex items-end justify-between">
                                    <div class="text-2xl font-bold text-white font-mono" id="ramUsedMain">-- GB</div>
                                    <div class="text-sm text-zinc-500" id="ramTotalMain">/ -- GB</div>
                                </div>
                                <div class="w-full bg-black/30 h-2 rounded-full mt-3 overflow-hidden border border-white/5">
                                    <div id="ramBarMain" class="h-full rounded-full transition-all duration-500" style="width: 0%; background: linear-gradient(90deg, #f59e0b, #fbbf24);"></div>
                                </div>
                            </div>
                        </div>
                    </section>
                    <!-- System Info -->
                    <section class="glass-panel liquid-glass p-6 rounded-2xl">
                        <h2 class="text-base font-bold text-white mb-5">Software Stack</h2>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center py-2.5 border-b border-iris-border">
                                <span class="text-zinc-500 text-sm">Operating System</span>
                                <span class="text-white font-medium text-sm" id="osInfo">Loading...</span>
                            </div>
                            <div class="flex justify-between items-center py-2.5 border-b border-iris-border">
                                <span class="text-zinc-500 text-sm">Python Version</span>
                                <span class="text-white font-medium font-mono text-sm" id="pythonVersion">--</span>
                            </div>
                            <div class="flex justify-between items-center py-2.5 border-b border-iris-border">
                                <span class="text-zinc-500 text-sm">PyTorch / CUDA</span>
                                <span class="text-white font-medium font-mono text-sm" id="torchInfo">--</span>
                            </div>
                            <div class="flex justify-between items-center py-2.5">
                                <span class="text-zinc-500 text-sm">I.R.I.S. Core</span>
                                <span class="text-iris-accentLight font-bold font-mono text-sm">v1.2.0</span>
                            </div>
                        </div>
                    </section>
                    <!-- Discord Integration -->
                    <section class="glass-panel liquid-glass p-6 rounded-2xl">
                        <h2 class="text-base font-bold text-white mb-5 flex items-center gap-2">
                            <svg class="w-5 h-5 text-indigo-400" viewBox="0 0 24 24" fill="currentColor"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/></svg>
                            Discord Integration
                        </h2>
                        <div class="flex items-center justify-between p-4 bg-iris-card rounded-xl border border-iris-border">
                            <div class="flex items-center gap-3">
                                <div>
                                    <div class="text-sm font-medium text-white">Discord Bot</div>
                                    <div class="text-xs text-zinc-500">Share images to Discord</div>
                                </div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="discordBotToggle" class="sr-only peer" onchange="toggleDiscordBot()">
                                <div class="w-11 h-6 bg-zinc-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-500"></div>
                            </label>
                        </div>
                        <div id="discordStatus" class="flex items-center gap-2 p-3 mt-3 bg-iris-bg rounded-lg">
                            <span class="w-2 h-2 rounded-full bg-amber-500 animate-pulse"></span>
                            <span class="text-xs text-zinc-400">Not configured</span>
                        </div>
                    </section>
                </div>
            </div>
        </main>
    </div>
    <script>
        const API_URL = '';
        
        async function loadGpuInfo() {
            try {
                const response = await fetch(API_URL + '/api/gpu-info');
                const data = await response.json();
                if (data.status === 'success' && data.gpu) {
                    const gpu = data.gpu;
                    const gpuLoad = gpu.gpu_utilization ?? gpu.load ?? 0;
                    const gpuTemp = gpu.gpu_temp ?? gpu.temp ?? 0;
                    const vramUsedGB = gpu.vram_used ?? 0;
                    const vramTotalGB = gpu.vram_total ?? 4;
                    const vramPerc = vramTotalGB > 0 ? (vramUsedGB / vramTotalGB * 100) : 0;
                    const powerDraw = gpu.power_draw ?? 0;
                    const gpuName = gpu.gpu_name ?? '--';
                    
                    // CPU & RAM
                    const cpuPercent = gpu.cpu_percent ?? 0;
                    const cpuFreq = gpu.cpu_freq ?? 0;
                    const cpuCores = gpu.cpu_cores ?? 0;
                    const ramUsed = gpu.ram_used ?? 0;
                    const ramTotal = gpu.ram_total ?? 0;
                    const ramPercent = gpu.ram_percent ?? 0;
                    
                    // Sidebar stats
                    document.getElementById('gpuLoad').textContent = Math.round(gpuLoad) + '%';
                    document.getElementById('gpuBar').style.width = gpuLoad + '%';
                    document.getElementById('vramUsed').textContent = vramUsedGB.toFixed(1);
                    document.getElementById('vramTotal').textContent = vramTotalGB.toFixed(1);
                    document.getElementById('vramBar').style.width = vramPerc + '%';
                    
                    // GPU stats
                    document.getElementById('gpuLoadMain').textContent = Math.round(gpuLoad) + '%';
                    document.getElementById('gpuTemp').textContent = gpuTemp > 0 ? Math.round(gpuTemp) + '°C' : '--°C';
                    document.getElementById('gpuBarMain').style.width = Math.min(gpuLoad, 100) + '%';
                    document.getElementById('gpuPower').textContent = powerDraw > 0 ? powerDraw.toFixed(0) + ' W' : '-- W';
                    document.getElementById('gpuName').textContent = gpuName.replace('NVIDIA ', '').replace('GeForce ', '');
                    
                    // VRAM stats
                    document.getElementById('vramUsedMain').textContent = vramUsedGB.toFixed(1) + ' GB';
                    document.getElementById('vramTotalMain').textContent = '/ ' + vramTotalGB.toFixed(1) + ' GB';
                    document.getElementById('vramBarMain').style.width = vramPerc + '%';
                    
                    // CPU stats
                    document.getElementById('cpuLoadMain').textContent = Math.round(cpuPercent) + '%';
                    document.getElementById('cpuFreq').textContent = cpuFreq > 0 ? cpuFreq.toFixed(2) + ' GHz' : '-- GHz';
                    document.getElementById('cpuBarMain').style.width = Math.min(cpuPercent, 100) + '%';
                    document.getElementById('cpuCores').textContent = cpuCores > 0 ? cpuCores + ' Cores' : '-- Cores';
                    
                    // RAM stats
                    document.getElementById('ramUsedMain').textContent = ramUsed.toFixed(1) + ' GB';
                    document.getElementById('ramTotalMain').textContent = '/ ' + ramTotal.toFixed(1) + ' GB';
                    document.getElementById('ramBarMain').style.width = ramPercent + '%';
                    
                    // Color coding for GPU
                    const gpuBarMain = document.getElementById('gpuBarMain');
                    if (gpuLoad > 80) gpuBarMain.style.background = 'linear-gradient(90deg, #ef4444, #f87171)';
                    else if (gpuLoad > 50) gpuBarMain.style.background = 'linear-gradient(90deg, #f59e0b, #fbbf24)';
                    else gpuBarMain.style.background = 'linear-gradient(90deg, #8b5cf6, #a78bfa)';
                    
                    // Color coding for VRAM
                    const vramBarMain = document.getElementById('vramBarMain');
                    if (vramPerc > 85) vramBarMain.style.background = 'linear-gradient(90deg, #ef4444, #f87171)';
                    else if (vramPerc > 60) vramBarMain.style.background = 'linear-gradient(90deg, #f59e0b, #fbbf24)';
                    else vramBarMain.style.background = 'linear-gradient(90deg, #6366f1, #818cf8)';
                    
                    // Color coding for CPU
                    const cpuBarMain = document.getElementById('cpuBarMain');
                    if (cpuPercent > 80) cpuBarMain.style.background = 'linear-gradient(90deg, #ef4444, #f87171)';
                    else if (cpuPercent > 50) cpuBarMain.style.background = 'linear-gradient(90deg, #f59e0b, #fbbf24)';
                    else cpuBarMain.style.background = 'linear-gradient(90deg, #10b981, #34d399)';
                    
                    // Color coding for RAM
                    const ramBarMain = document.getElementById('ramBarMain');
                    if (ramPercent > 85) ramBarMain.style.background = 'linear-gradient(90deg, #ef4444, #f87171)';
                    else if (ramPercent > 60) ramBarMain.style.background = 'linear-gradient(90deg, #f59e0b, #fbbf24)';
                    else ramBarMain.style.background = 'linear-gradient(90deg, #f59e0b, #fbbf24)';
                }
            } catch (e) { console.error('GPU Info error', e); }
        }
        
        async function loadVersionInfo() {
            try {
                const response = await fetch(API_URL + '/api/version');
                const data = await response.json();
                document.getElementById('osInfo').textContent = data.os || 'Unknown';
                document.getElementById('pythonVersion').textContent = data.python_version || '--';
                document.getElementById('torchInfo').textContent = data.pytorch_version && data.cuda_version ? data.pytorch_version + ' / ' + data.cuda_version : '--';
            } catch (e) { console.error('Version info error', e); }
        }
        
        async function loadStats() {
            try {
                const response = await fetch(API_URL + '/api/output-gallery');
                const data = await response.json();
                const count = data.images?.length || 0;
                document.getElementById('statImages').textContent = count + ' images';
                document.getElementById('statStorage').textContent = (count * 1.5).toFixed(1) + ' MB used';
            } catch (e) { console.error('Stats error', e); }
        }
        async function loadSettings() {
            try {
                const response = await fetch('/api/settings');
                const data = await response.json();
                if (data.success && data.settings) {
                    applySettings(data.settings);
                    localStorage.setItem('iris_settings', JSON.stringify(data.settings));
                    return;
                }
            } catch (e) { console.log('Server settings not available, using localStorage'); }
            const settings = JSON.parse(localStorage.getItem('iris_settings') || '{}');
            applySettings(settings);
        }
        
        function applySettings(settings) {
            // DRAM Extension
            const dramToggle = document.getElementById('dramExtensionToggle');
            const dramSettings = document.getElementById('dramSettings');
            if (typeof settings.dramEnabled !== 'undefined') {
                dramToggle.checked = settings.dramEnabled;
                dramSettings.classList.toggle('hidden', !settings.dramEnabled);
            }
            if (typeof settings.vramThreshold !== 'undefined') {
                document.getElementById('vramThresholdSlider').value = settings.vramThreshold;
                document.getElementById('vramThresholdValue').textContent = settings.vramThreshold + ' GB';
            }
            if (typeof settings.maxDram !== 'undefined') {
                document.getElementById('maxDramSlider').value = settings.maxDram;
                document.getElementById('maxDramValue').textContent = settings.maxDram + ' GB';
            }
            // NSFW Filter
            if (typeof settings.nsfwEnabled !== 'undefined') {
                document.getElementById('nsfwFilterToggle').checked = settings.nsfwEnabled;
                toggleNsfwFilter();
            }
            if (typeof settings.nsfwStrength !== 'undefined') {
                document.getElementById('nsfwStrengthSlider').value = settings.nsfwStrength;
                updateNsfwStrength(settings.nsfwStrength);
            }
            // Discord Bot - only update toggle, not status (status comes from API)
            if (typeof settings.discordEnabled !== 'undefined') {
                document.getElementById('discordBotToggle').checked = settings.discordEnabled;
            }
        }
        
        function toggleDramExtension() {
            const enabled = document.getElementById('dramExtensionToggle').checked;
            document.getElementById('dramSettings').classList.toggle('hidden', !enabled);
        }
        
        function updateVramThreshold(value) {
            document.getElementById('vramThresholdValue').textContent = value + ' GB';
        }
        
        function updateMaxDram(value) {
            document.getElementById('maxDramValue').textContent = value + ' GB';
        }
        
        function updateNsfwStrength(value) {
            const labels = { 1: 'Relaxed', 2: 'Standard', 3: 'Strict' };
            document.getElementById('nsfwStrengthValue').textContent = labels[value] || 'Standard';
        }
        
        function toggleNsfwFilter() {
            const enabled = document.getElementById('nsfwFilterToggle').checked;
            const settings = document.getElementById('nsfwFilterSettings');
            const warning = document.getElementById('nsfwFilterWarning');
            if (enabled) { settings.classList.remove('hidden'); warning.classList.add('hidden'); }
            else { settings.classList.add('hidden'); warning.classList.remove('hidden'); }
        }
        
        async function toggleDiscordBot() {
            const enabled = document.getElementById('discordBotToggle').checked;
            if (enabled) {
                document.getElementById('discordStatus').innerHTML = '<span class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></span><span class="text-xs text-yellow-400">Starting...</span>';
                try {
                    const response = await fetch('/api/discord-bot', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ enabled: true }) });
                    const data = await response.json();
                    if (data.success) {
                        document.getElementById('discordStatus').innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500"></span><span class="text-xs text-green-400">Running</span>';
                    } else {
                        const errorMsg = data.message || 'Failed';
                        const displayMsg = errorMsg === 'Bot token not configured' ? 'Token missing' : errorMsg;
                        document.getElementById('discordStatus').innerHTML = '<span class="w-2 h-2 rounded-full bg-red-500"></span><span class="text-xs text-red-400">' + displayMsg + '</span>';
                        document.getElementById('discordBotToggle').checked = false;
                    }
                } catch (e) {
                    document.getElementById('discordStatus').innerHTML = '<span class="w-2 h-2 rounded-full bg-red-500"></span><span class="text-xs text-red-400">Server offline</span>';
                    document.getElementById('discordBotToggle').checked = false;
                }
            } else {
                document.getElementById('discordStatus').innerHTML = '<span class="w-2 h-2 rounded-full bg-amber-500 animate-pulse"></span><span class="text-xs text-zinc-400">Not configured</span>';
                try { await fetch('/api/discord-bot', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ enabled: false }) }); } catch (e) {}
            }
        }
        async function saveAllSettings() {
            const settings = {
                dramEnabled: document.getElementById('dramExtensionToggle').checked,
                vramThreshold: parseInt(document.getElementById('vramThresholdSlider').value),
                maxDram: parseInt(document.getElementById('maxDramSlider').value),
                nsfwEnabled: document.getElementById('nsfwFilterToggle').checked,
                nsfwStrength: parseInt(document.getElementById('nsfwStrengthSlider').value),
                discordEnabled: document.getElementById('discordBotToggle').checked
            };
            localStorage.setItem('iris_settings', JSON.stringify(settings));
            
            const btn = document.querySelector('[onclick="saveAllSettings()"]');
            const btnText = document.getElementById('saveButtonText');
            btnText.textContent = 'Saving...';
            
            try {
                const response = await fetch('/api/settings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(settings) });
                const data = await response.json();
                if (data.success) { btnText.textContent = 'Saved!'; btn.classList.add('bg-green-600'); }
                else throw new Error(data.message || 'Save failed');
            } catch (e) {
                console.log('Server settings save failed:', e);
                btnText.textContent = 'Saved (local)';
                btn.classList.add('bg-yellow-600');
            }
            
            setTimeout(() => { btnText.textContent = 'Save Settings'; btn.classList.remove('bg-green-600', 'bg-yellow-600'); }, 2000);
        }
        
        let lastSettingsJson = null;
        async function pollSettings() {
            try {
                const response = await fetch('/api/settings');
                const data = await response.json();
                if (data.success && data.settings) {
                    const newJson = JSON.stringify(data.settings);
                    if (lastSettingsJson !== newJson) {
                        lastSettingsJson = newJson;
                        applySettings(data.settings);
                    }
                }
            } catch (e) { /* ignore polling errors */ }
        }
        
        async function loadDiscordStatus() {
            try {
                const response = await fetch('/api/discord-bot/status');
                const data = await response.json();
                const statusEl = document.getElementById('discordStatus');
                if (data.running) {
                    statusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500"></span><span class="text-xs text-green-400">Running</span>';
                    document.getElementById('discordBotToggle').checked = true;
                } else {
                    const isChecked = document.getElementById('discordBotToggle').checked;
                    if (!isChecked) {
                        statusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-amber-500 animate-pulse"></span><span class="text-xs text-zinc-400">Not configured</span>';
                    }
                }
            } catch (e) { /* ignore */ }
        }
        
        // Device switching
        let currentDevice = 'cuda';
        let availableDevices = [];
        
        const deviceIcons = {
            nvidia: '<svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>',
            amd: '<svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M3 3h18v18H3V3zm16 16V5H5v14h14zM7 7h4v4H7V7zm6 0h4v4h-4V7zm-6 6h4v4H7v-4zm6 0h4v4h-4v-4z"/></svg>',
            intel: '<svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2V7zm0 8h2v2h-2v-2z"/></svg>',
            apple: '<svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/></svg>',
            cpu: '<svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M15 9H9v6h6V9zm-2 4h-2v-2h2v2zm8-2V9h-2V7c0-1.1-.9-2-2-2h-2V3h-2v2h-2V3H9v2H7c-1.1 0-2 .9-2 2v2H3v2h2v2H3v2h2v2c0 1.1.9 2 2 2h2v2h2v-2h2v2h2v-2h2c1.1 0 2-.9 2-2v-2h2v-2h-2v-2h2zm-4 6H7V7h10v10z"/></svg>'
        };
        
        const deviceColors = {
            nvidia: { active: 'bg-green-600', inactive: 'bg-zinc-700 hover:bg-zinc-600' },
            amd: { active: 'bg-red-600', inactive: 'bg-zinc-700 hover:bg-zinc-600' },
            intel: { active: 'bg-blue-600', inactive: 'bg-zinc-700 hover:bg-zinc-600' },
            apple: { active: 'bg-gray-600', inactive: 'bg-zinc-700 hover:bg-zinc-600' },
            cpu: { active: 'bg-emerald-600', inactive: 'bg-zinc-700 hover:bg-zinc-600' }
        };
        
        async function loadDevices() {
            try {
                const response = await fetch(API_URL + '/api/devices');
                const data = await response.json();
                currentDevice = data.current_device;
                availableDevices = data.devices || [];
                renderDeviceButtons();
            } catch (e) { console.error('Failed to load devices:', e); }
        }
        
        function renderDeviceButtons() {
            const container = document.getElementById('deviceButtons');
            container.innerHTML = '';
            
            availableDevices.forEach(device => {
                const isActive = device.id === currentDevice;
                const colors = deviceColors[device.type] || deviceColors.cpu;
                const icon = deviceIcons[device.type] || deviceIcons.cpu;
                
                // Get short label
                let label = device.id.toUpperCase();
                if (device.type === 'nvidia') label = 'NVIDIA';
                else if (device.type === 'amd') label = 'AMD';
                else if (device.type === 'intel') label = 'Intel Arc';
                else if (device.type === 'apple') label = 'Apple';
                else if (device.type === 'cpu') label = 'CPU';
                
                const btn = document.createElement('button');
                btn.onclick = () => switchDevice(device.id);
                btn.disabled = !device.available;
                btn.className = `flex-1 min-w-[80px] py-2.5 px-4 rounded-lg text-sm font-medium transition-all ${isActive ? colors.active + ' text-white' : colors.inactive + ' text-zinc-300'} disabled:opacity-50 disabled:cursor-not-allowed`;
                btn.innerHTML = `<span class="flex items-center justify-center gap-2">${icon}${label}</span>`;
                container.appendChild(btn);
            });
            
            // Show current device info
            const currentDeviceInfo = availableDevices.find(d => d.id === currentDevice);
            if (currentDeviceInfo) {
                document.getElementById('deviceInfo').textContent = currentDeviceInfo.name;
            }
        }
        
        async function switchDevice(device) {
            if (device === currentDevice) return;
            
            const statusEl = document.getElementById('deviceSwitchStatus');
            statusEl.textContent = 'Switching...';
            statusEl.className = 'text-xs text-yellow-400';
            
            // Disable all buttons during switch
            document.querySelectorAll('#deviceButtons button').forEach(btn => btn.disabled = true);
            
            try {
                const response = await fetch(API_URL + '/api/device?device=' + device, { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    currentDevice = data.new_device;
                    renderDeviceButtons();
                    statusEl.textContent = data.model_reloaded ? 'Switched & model reloaded' : 'Switched';
                    statusEl.className = 'text-xs text-green-400';
                    setTimeout(() => { statusEl.textContent = ''; }, 3000);
                } else {
                    statusEl.textContent = 'Failed';
                    statusEl.className = 'text-xs text-red-400';
                }
            } catch (e) {
                console.error('Device switch error:', e);
                statusEl.textContent = 'Error';
                statusEl.className = 'text-xs text-red-400';
            }
            
            // Re-enable buttons and reload device info
            await loadDevices();
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            loadVersionInfo();
            loadGpuInfo();
            loadStats();
            loadDiscordStatus();
            loadDevices();
            setInterval(loadGpuInfo, 3000);
            // Poll settings every 2 seconds for live sync with React frontend
            setInterval(pollSettings, 2000);
            // Poll Discord status every 5 seconds
            setInterval(loadDiscordStatus, 5000);
        });
    </script>
</body>
</html>