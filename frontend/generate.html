<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I.R.I.S. Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/x-icon" href="/assets/fav.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/generate.css">
    
    <!-- WebSocket Manager for auto-reconnection -->
    <script src="/static/js/websocket-manager.js"></script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/js/service-worker.js')
                    .then(reg => console.log('[SW] Registered:', reg.scope))
                    .catch(err => console.error('[SW] Registration failed:', err));
            });
        }
    </script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        iris: {
                            bg: '#0a0a0f',
                            panel: '#12121a',
                            card: '#1a1a24',
                            elevated: '#22222e',
                            border: 'rgba(255, 255, 255, 0.08)',
                            accent: '#8b5cf6',
                            accentLight: '#a78bfa',
                            text: '#f4f4f5',
                            muted: '#71717a'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="text-sm selection:bg-purple-500/30 selection:text-purple-100">

    <div class="flex h-full w-full overflow-hidden">
        
        <!-- === SIDEBAR === -->
        <aside class="w-[320px] lg:w-[360px] flex flex-col bg-iris-panel border-r border-iris-border flex-shrink-0 z-20">
            
            <!-- Logo Header -->
            <div class="h-14 flex items-center justify-between px-4 border-b border-iris-border">
                <a href="/" class="flex items-center gap-2.5 group">
                    <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-violet-500 via-purple-500 to-indigo-600 flex items-center justify-center shadow-lg shadow-purple-500/20 group-hover:shadow-purple-500/40 transition-shadow">
                        <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                    </div>
                    <div>
                        <h1 class="font-bold text-base tracking-tight text-white leading-none">I.R.I.S.</h1>
                        <span class="text-[9px] font-mono text-purple-400/80 tracking-widest">AI STUDIO</span>
                    </div>
                </a>
                <div class="flex items-center gap-1">
                    <span id="gpuStatusDot" class="w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.6)]"></span>
                    <span id="gpuStatusText" class="text-[10px] font-medium text-zinc-500">Ready</span>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="px-3 py-2 border-b border-iris-border">
                <div class="flex gap-1 p-1 bg-iris-bg/50 rounded-lg">
                    <a href="/" class="flex-1 px-3 py-1.5 text-center text-[11px] font-medium rounded-md text-zinc-400 hover:text-white hover:bg-white/5 transition-all">Home</a>
                    <a href="/generate" class="flex-1 px-3 py-1.5 text-center text-[11px] font-medium rounded-md bg-iris-accent/20 text-iris-accentLight border border-iris-accent/30">Create</a>
                    <a href="/gallery" class="flex-1 px-3 py-1.5 text-center text-[11px] font-medium rounded-md text-zinc-400 hover:text-white hover:bg-white/5 transition-all">Gallery</a>
                    <a href="/settings" class="flex-1 px-3 py-1.5 text-center text-[11px] font-medium rounded-md text-zinc-400 hover:text-white hover:bg-white/5 transition-all">Settings</a>
                </div>
            </nav>

            <!-- Scrollable Controls -->
            <div class="flex-1 overflow-y-auto custom-scrollbar">
                <div class="p-4 space-y-5">

                    <!-- MODEL SELECTOR -->
                    <div class="space-y-2">
                        <label class="sidebar-label">
                            <svg style="width:12px;height:12px;min-width:12px;max-width:12px;" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                            Model
                        </label>
                        <div class="relative" id="customModelDropdown">
                            <button type="button" onclick="toggleModelDropdown()" class="w-full liquid-glass-input border border-iris-border rounded-xl text-sm text-white p-3 flex items-center justify-between hover:border-iris-accent/50 transition-all group focus:outline-none focus:ring-2 focus:ring-iris-accent/30">
                                <div class="flex items-center gap-3 overflow-hidden">
                                    <div id="selectedModelPreview" class="w-9 h-9 rounded-lg bg-zinc-800 flex-shrink-0 bg-cover bg-center hidden border border-white/10"></div>
                                    <span id="selectedModelName" class="truncate font-medium text-zinc-300">Select Model</span>
                                </div>
                                <svg class="w-4 h-4 text-zinc-500 group-hover:text-iris-accent transition-all duration-200" id="dropdownArrow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                            <div id="modelDropdownList" class="hidden absolute top-full left-0 right-0 mt-2 liquid-glass border border-iris-border rounded-xl shadow-2xl z-50 max-h-[300px] overflow-y-auto custom-scrollbar"></div>
                            <input type="hidden" id="styleSelect" value="anime_kawai">
                        </div>
                    </div>

                    <!-- PROMPT -->
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <label class="sidebar-label mb-0">
                                <svg style="width:12px;height:12px;min-width:12px;max-width:12px;" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                Prompt
                            </label>
                            <button onclick="randomPrompt()" class="p-1.5 rounded-lg hover:bg-white/5 text-zinc-500 hover:text-iris-accent transition" title="Random Prompt">
                                <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                            </button>
                        </div>
                        <div class="liquid-glass-input rounded-xl overflow-hidden relative group">
                            <textarea id="promptInput" class="w-full bg-transparent text-white p-3 text-sm focus:ring-0 resize-y min-h-[100px] placeholder-zinc-600 leading-relaxed" placeholder="Describe your image...">masterpiece, best quality, ultra-detailed, high resolution, cinematic lighting, 1girl, anime girl with cyan hair, cat ears, fox tail, wearing white tactical jacket, black pleated skirt, futuristic city background, soft bokeh, glowing eyes</textarea>
                        </div>

                        <!-- NEGATIVE PROMPT -->
                        <details class="group/neg">
                            <summary class="flex items-center gap-2 cursor-pointer p-2 rounded-lg hover:bg-white/5 transition-colors select-none">
                                <svg class="w-3.5 h-3.5 text-zinc-500 transition-transform group-open/neg:rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                                <span class="text-[11px] font-medium text-zinc-500 group-open/neg:text-zinc-300">Negative Prompt</span>
                            </summary>
                            <div class="mt-2">
                                <textarea id="negativePromptInput" class="w-full bg-iris-card border border-iris-border rounded-xl text-zinc-400 p-3 text-xs h-20 focus:border-red-500/30 focus:ring-1 focus:ring-red-500/20 resize-none placeholder-zinc-600" placeholder="What to avoid...">lowres, bad anatomy, bad hands, text, error, missing fingers, extra digit, fewer digits, cropped, worst quality, low quality, jpeg artifacts, signature, watermark, blurry, deformed</textarea>
                            </div>
                        </details>
                    </div>

                    <div class="h-px bg-gradient-to-r from-transparent via-iris-border to-transparent"></div>

                    <!-- DIMENSIONS -->
                    <div class="space-y-3">
                        <label class="sidebar-label">
                            <svg style="width:12px;height:12px;min-width:12px;max-width:12px;" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"></path></svg>
                            Dimensions
                        </label>
                        <div class="grid grid-cols-4 gap-1.5">
                            <button type="button" onclick="setVisualResolution('512x512', this)" class="aspect-btn active rounded-lg aspect-square flex flex-col items-center justify-center" title="1:1 Square (512x512)">
                                <div class="aspect-preview w-4 h-4"></div>
                                <span class="text-xs font-medium leading-none mt-1">1:1</span>
                                <span class="text-[10px] text-zinc-600 leading-none">512Ã—512</span>
                            </button>
                            <button type="button" onclick="setVisualResolution('512x768', this)" class="aspect-btn rounded-lg aspect-square flex flex-col items-center justify-center" title="2:3 Portrait (512x768)">
                                <div class="aspect-preview w-3 h-[16px]"></div>
                                <span class="text-xs font-medium leading-none mt-1">2:3</span>
                                <span class="text-[10px] text-zinc-600 leading-none">512Ã—768</span>
                            </button>
                            <button type="button" onclick="setVisualResolution('768x512', this)" class="aspect-btn rounded-lg aspect-square flex flex-col items-center justify-center" title="3:2 Landscape (768x512)">
                                <div class="aspect-preview w-[16px] h-3"></div>
                                <span class="text-xs font-medium leading-none mt-1">3:2</span>
                                <span class="text-[10px] text-zinc-600 leading-none">768Ã—512</span>
                            </button>
                            <button type="button" onclick="setVisualResolution('768x1024', this)" class="aspect-btn rounded-lg aspect-square flex flex-col items-center justify-center" title="3:4 Portrait (768x1024)">
                                <div class="aspect-preview w-3 h-[15px]"></div>
                                <span class="text-xs font-medium leading-none mt-1">3:4</span>
                                <span class="text-[10px] text-zinc-600 leading-none">768Ã—1024</span>
                            </button>
                            <button type="button" onclick="setVisualResolution('1024x768', this)" class="aspect-btn rounded-lg aspect-square flex flex-col items-center justify-center" title="4:3 Landscape (1024x768)">
                                <div class="aspect-preview w-[15px] h-3"></div>
                                <span class="text-xs font-medium leading-none mt-1">4:3</span>
                                <span class="text-[10px] text-zinc-600 leading-none">1024Ã—768</span>
                            </button>
                            <button type="button" onclick="setVisualResolution('720x1280', this)" class="aspect-btn rounded-lg aspect-square flex flex-col items-center justify-center" title="9:16 Mobile (720x1280)">
                                <div class="aspect-preview w-2.5 h-[16px]"></div>
                                <span class="text-xs font-medium leading-none mt-1">9:16</span>
                                <span class="text-[10px] text-zinc-600 leading-none">720Ã—1280</span>
                            </button>
                            <button type="button" onclick="setVisualResolution('1080x1920', this)" class="aspect-btn rounded-lg aspect-square flex flex-col items-center justify-center" title="9:16 HD (1080x1920)">
                                <div class="aspect-preview w-2.5 h-[16px]"></div>
                                <span class="text-xs font-medium leading-none mt-1">FHD</span>
                                <span class="text-[10px] text-zinc-600 leading-none">1080Ã—1920</span>
                            </button>
                            <button type="button" onclick="toggleCustomRes()" id="customResBtn" class="aspect-btn rounded-lg aspect-square flex flex-col items-center justify-center" title="Custom">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                                <span class="text-xs font-medium leading-none mt-1">Custom</span>
                                <span class="text-[10px] text-zinc-600 leading-none">manual</span>
                            </button>
                        </div>
                        <select id="resSelect" onchange="handleResolutionChange()" class="hidden">
                            <option value="512x512">1:1 (512x512)</option>
                            <option value="512x768">2:3 (512x768)</option>
                            <option value="768x512">3:2 (768x512)</option>
                            <option value="768x1024">3:4 (768x1024)</option>
                            <option value="1024x768">4:3 (1024x768)</option>
                            <option value="720x1280">9:16 (720x1280)</option>
                            <option value="1080x1920">9:16 HD (1080x1920)</option>
                            <option value="custom">Custom</option>
                        </select>
                        <div id="customResContainer" class="hidden pt-2">
                            <div class="liquid-glass-input border border-iris-border rounded-xl p-3">
                                <div class="flex items-center gap-3">
                                    <div class="flex-1">
                                        <label class="text-[10px] text-zinc-500 uppercase font-semibold block mb-1.5">Width</label>
                                        <input type="number" id="customWidth" value="512" min="256" max="4096" step="64" class="bg-iris-bg border border-iris-border rounded-lg px-3 py-2 w-full text-white text-sm font-mono focus:border-iris-accent focus:outline-none focus:ring-1 focus:ring-iris-accent/30 transition-all">
                                    </div>
                                    <div class="flex flex-col items-center pt-5">
                                        <span class="text-zinc-500 text-lg">Ã—</span>
                                    </div>
                                    <div class="flex-1">
                                        <label class="text-[10px] text-zinc-500 uppercase font-semibold block mb-1.5">Height</label>
                                        <input type="number" id="customHeight" value="512" min="256" max="4096" step="64" class="bg-iris-bg border border-iris-border rounded-lg px-3 py-2 w-full text-white text-sm font-mono focus:border-iris-accent focus:outline-none focus:ring-1 focus:ring-iris-accent/30 transition-all">
                                    </div>
                                </div>
                                <div class="flex gap-2 mt-3">
                                    <button type="button" onclick="swapCustomDimensions()" class="flex-1 py-1.5 px-3 rounded-lg border border-iris-border bg-iris-card text-zinc-400 hover:text-white hover:border-white/20 transition-all text-xs flex items-center justify-center gap-1.5">
                                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
                                        Swap
                                    </button>
                                    <button type="button" onclick="setCustomPreset(512, 512)" class="py-1.5 px-2.5 rounded-lg border border-iris-border bg-iris-card text-zinc-400 hover:text-white hover:border-white/20 transition-all text-[10px]">512Â²</button>
                                    <button type="button" onclick="setCustomPreset(768, 768)" class="py-1.5 px-2.5 rounded-lg border border-iris-border bg-iris-card text-zinc-400 hover:text-white hover:border-white/20 transition-all text-[10px]">768Â²</button>
                                    <button type="button" onclick="setCustomPreset(1024, 1024)" class="py-1.5 px-2.5 rounded-lg border border-iris-border bg-iris-card text-zinc-400 hover:text-white hover:border-white/20 transition-all text-[10px]">1024Â²</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- QUALITY PRESET -->
                    <div class="space-y-2">
                        <label class="sidebar-label">
                            <svg style="width:12px;height:12px;min-width:12px;max-width:12px;" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                            Generation Mode
                        </label>
                        <div class="relative" id="modeDropdownContainer">
                            <button type="button" onclick="toggleModeDropdown()" class="w-full liquid-glass-input border border-iris-border rounded-xl text-sm text-white p-3 flex items-center justify-between hover:border-iris-accent/50 transition-all group focus:outline-none focus:ring-2 focus:ring-iris-accent/30">
                                <div class="flex items-center gap-3">
                                    <div id="selectedModeIcon" class="w-8 h-8 rounded-lg bg-iris-accent/20 flex items-center justify-center">
                                        <svg class="w-4 h-4 text-iris-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                                    </div>
                                    <div class="text-left">
                                        <span id="selectedModeName" class="font-medium text-zinc-200 block">Balanced</span>
                                        <span id="selectedModeDesc" class="text-[10px] text-zinc-500">35 steps â€¢ Good quality</span>
                                    </div>
                                </div>
                                <svg class="w-4 h-4 text-zinc-500 group-hover:text-iris-accent transition-all duration-200" id="modeDropdownArrow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                            <div id="modeDropdownList" class="hidden absolute top-full left-0 right-0 mt-2 liquid-glass border border-iris-border rounded-xl shadow-2xl z-50 overflow-hidden">
                                <div onclick="selectMode('fast')" class="mode-option flex items-center gap-3 p-3 hover:bg-iris-accent/10 cursor-pointer transition-colors border-b border-iris-border/50">
                                    <div class="w-8 h-8 rounded-lg bg-emerald-500/20 flex items-center justify-center">
                                        <svg class="w-4 h-4 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                                    </div>
                                    <div>
                                        <span class="font-medium text-zinc-200 block text-sm">Fast (Draft)</span>
                                        <span class="text-[10px] text-zinc-500">15 steps â€¢ Quick preview</span>
                                    </div>
                                </div>
                                <div onclick="selectMode('balanced')" class="mode-option flex items-center gap-3 p-3 hover:bg-iris-accent/10 cursor-pointer transition-colors border-b border-iris-border/50 bg-iris-accent/5">
                                    <div class="w-8 h-8 rounded-lg bg-iris-accent/20 flex items-center justify-center">
                                        <svg class="w-4 h-4 text-iris-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    </div>
                                    <div>
                                        <span class="font-medium text-zinc-200 block text-sm">Balanced</span>
                                        <span class="text-[10px] text-zinc-500">35 steps â€¢ Good quality</span>
                                    </div>
                                </div>
                                <div onclick="selectMode('high')" class="mode-option flex items-center gap-3 p-3 hover:bg-iris-accent/10 cursor-pointer transition-colors border-b border-iris-border/50">
                                    <div class="w-8 h-8 rounded-lg bg-amber-500/20 flex items-center justify-center">
                                        <svg class="w-4 h-4 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg>
                                    </div>
                                    <div>
                                        <span class="font-medium text-zinc-200 block text-sm">High Quality</span>
                                        <span class="text-[10px] text-zinc-500">50 steps â€¢ Detailed output</span>
                                    </div>
                                </div>
                                <div onclick="selectMode('extreme')" class="mode-option flex items-center gap-3 p-3 hover:bg-iris-accent/10 cursor-pointer transition-colors">
                                    <div class="w-8 h-8 rounded-lg bg-red-500/20 flex items-center justify-center">
                                        <svg class="w-4 h-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z"></path></svg>
                                    </div>
                                    <div>
                                        <span class="font-medium text-zinc-200 block text-sm">Extreme</span>
                                        <span class="text-[10px] text-zinc-500">100 steps â€¢ Maximum quality</span>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" id="qualityPreset" value="balanced">
                        </div>
                    </div>
                    <div class="h-px bg-gradient-to-r from-transparent via-iris-border to-transparent"></div>

                    <!-- ADVANCED SETTINGS -->
                    <details class="group">
                        <summary class="flex justify-between items-center cursor-pointer py-2 text-xs font-semibold text-zinc-500 hover:text-white transition-colors select-none">
                            <div class="flex items-center gap-2">
                                <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                <span>Advanced</span>
                            </div>
                            <svg class="w-4 h-4 transition-transform group-open:rotate-180 text-zinc-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </summary>
                        
                        <div class="pt-4 space-y-5">
                            <!-- Steps -->
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <label class="text-[10px] uppercase text-zinc-500 font-semibold">Steps</label>
                                    <span id="stepsValue" class="text-[10px] font-mono text-iris-accent bg-iris-accent/10 px-2 py-0.5 rounded-md">35</span>
                                </div>
                                <input id="stepsSlider" type="range" min="1" max="150" value="35" class="w-full" oninput="document.getElementById('stepsValue').textContent = this.value">
                            </div>

                            <!-- CFG -->
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <label class="text-[10px] uppercase text-zinc-500 font-semibold">CFG Scale</label>
                                    <span id="cfgValue" class="text-[10px] font-mono text-iris-accent bg-iris-accent/10 px-2 py-0.5 rounded-md">10.0</span>
                                </div>
                                <input id="cfgSlider" type="range" min="1" max="20" step="0.1" value="10" class="w-full" oninput="document.getElementById('cfgValue').textContent = parseFloat(this.value).toFixed(1)">
                            </div>

                            <!-- Seed -->
                            <div class="space-y-2">
                                <label class="text-[10px] uppercase text-zinc-500 font-semibold">Seed</label>
                                <div class="liquid-glass-input border border-iris-border rounded-xl p-3">
                                    <div class="flex items-center gap-3">
                                        <input type="number" id="seedInput" placeholder="-1" value="-1" class="flex-1 bg-transparent text-white text-lg font-mono focus:outline-none min-w-0 [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none">
                                        <div class="flex gap-1.5">
                                            <button id="seedLockBtn" onclick="toggleSeedLock()" class="w-9 h-9 rounded-lg border border-iris-border bg-iris-card text-zinc-500 hover:text-iris-accent hover:border-iris-accent/50 transition-all flex items-center justify-center" title="Lock Seed">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"></path></svg>
                                            </button>
                                            <button onclick="randomSeed()" class="w-9 h-9 rounded-lg border border-iris-border bg-iris-card text-zinc-500 hover:text-white hover:border-white/20 transition-all flex items-center justify-center" title="Randomize">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2 mt-2 pt-2 border-t border-iris-border/50">
                                        <span class="text-[10px] text-zinc-600">-1 = Random</span>
                                        <span id="seedLockStatus" class="text-[10px] text-zinc-600 ml-auto hidden">ðŸ”’ Locked</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Safety Filter - Original Style -->
                            <div class="pt-4 border-t border-white/10">
                                <label class="text-[10px] uppercase text-zinc-500 font-semibold flex items-center gap-2 mb-3">
                                    <svg class="w-3.5 h-3.5 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    Safety Filters
                                </label>
                                <div class="flex items-center gap-2 bg-iris-card rounded-lg p-2.5 border border-green-500/30">
                                    <svg class="w-4 h-4 text-green-400" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"></path></svg>
                                    <span class="text-xs font-medium text-white">NSFW Filter</span>
                                    <span class="text-[9px] bg-green-500/20 text-green-300 px-2 py-0.5 rounded">ALWAYS ACTIVE</span>
                                </div>
                            </div>
                        </div>
                    </details>
                </div>
            </div>

            <!-- Generate Button -->
            <div class="p-4 border-t border-iris-border bg-iris-panel">
                <button id="generateBtn" onclick="generateImage()" class="btn-generate liquid-glass-btn w-full py-3.5 rounded-xl font-bold text-sm tracking-wide text-white flex items-center justify-center gap-2 group">
                    <svg class="w-5 h-5 group-hover:scale-110 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    <span>Generate</span>
                </button>
            </div>
        </aside>

        <!-- === MAIN CONTENT === -->
        <main class="flex-1 flex flex-col min-w-0 bg-iris-bg relative">
            
            <!-- Top Bar -->
            <header class="h-12 border-b border-iris-border bg-iris-panel/80 backdrop-blur-sm flex items-center justify-between px-5 shrink-0 z-10">
                <div class="flex items-center gap-3">
                    <span id="imageInfo" class="text-xs text-zinc-500 font-mono"></span>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right">
                        <span class="text-xs font-mono text-zinc-400"><span id="imageCount">0</span> generated</span>
                    </div>
                </div>
            </header>

            <!-- Canvas Area -->
            <div class="flex-1 relative flex flex-col min-h-0">
                <div id="previewArea" class="flex-1 checkerboard-bg relative flex items-center justify-center p-6 pointer-events-none overflow-hidden min-h-0">
                    
                    <!-- Placeholder -->
                    <div id="placeholderText" class="text-center select-none pointer-events-none w-full h-full flex flex-col items-center justify-center">
                        <div class="relative mb-6">
                            <div class="w-24 h-24 rounded-2xl liquid-glass-subtle flex items-center justify-center">
                                <svg class="w-10 h-10 text-iris-accent/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                            </div>
                        </div>
                        <h3 class="text-lg font-light text-zinc-300 mb-2">Create something amazing</h3>
                        <p class="text-xs text-zinc-600 mb-4">Enter a prompt and click Generate</p>
                        <div class="flex gap-2">
                            <span class="px-2.5 py-1 rounded-full text-[9px] liquid-glass-subtle text-iris-accentLight font-medium">AI Powered</span>
                            <span class="px-2.5 py-1 rounded-full text-[9px] liquid-glass-subtle text-indigo-400 font-medium">Local Processing</span>
                        </div>
                    </div>

                    <!-- Generated Image -->
                    <img id="previewImage" class="hidden absolute max-h-[calc(100%-48px)] max-w-[calc(100%-48px)] object-contain shadow-2xl rounded-xl transition-all duration-500 pointer-events-auto" style="box-shadow: 0 25px 80px -20px rgba(0,0,0,0.8);" />
                    
                    <!-- Progress Overlay -->
                    <div id="progressContainer" class="hidden absolute inset-0 bg-iris-bg/95 backdrop-blur-xl flex flex-col items-center justify-center pointer-events-auto" style="z-index: 50;">
                        <div class="flex flex-col items-center gap-6 w-full max-w-md px-8">
                            <!-- Circular Timer -->
                            <div class="relative w-32 h-32">
                                <svg class="w-full h-full transform -rotate-90" style="filter: drop-shadow(0 0 20px rgba(139, 92, 246, 0.3));">
                                    <circle cx="64" cy="64" r="58" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="2"/>
                                    <circle id="timerCircle" cx="64" cy="64" r="58" fill="none" stroke="url(#timerGradient)" stroke-width="4" stroke-linecap="round" stroke-dasharray="364" stroke-dashoffset="364" style="transition: stroke-dashoffset 0.3s ease;"/>
                                    <defs>
                                        <linearGradient id="timerGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                            <stop offset="0%" style="stop-color:#a855f7" />
                                            <stop offset="100%" style="stop-color:#6366f1" />
                                        </linearGradient>
                                    </defs>
                                </svg>
                                <div class="absolute inset-0 flex flex-col items-center justify-center">
                                    <div id="timerDisplay" class="text-3xl font-bold text-white tabular-nums font-mono">0.0s</div>
                                    <div id="timerLabel" class="text-[9px] text-zinc-500 font-medium mt-0.5 uppercase tracking-wider">Generating</div>
                                </div>
                            </div>
                            
                            <!-- Progress Bar -->
                            <div class="w-full">
                                <div class="flex justify-between items-center mb-2">
                                    <span id="generationStatus" class="text-sm text-zinc-400">Initializing...</span>
                                    <span id="progressPercent" class="text-sm font-mono text-iris-accent">0%</span>
                                </div>
                                <div class="w-full h-2 bg-iris-card rounded-full overflow-hidden border border-iris-border">
                                    <div id="progressBar" class="h-full rounded-full transition-all duration-300 ease-out" style="width: 0%; background: linear-gradient(90deg, #8b5cf6, #6366f1);"></div>
                                </div>
                                <div class="flex justify-between items-center mt-2">
                                    <div class="flex items-center gap-2">
                                        <span class="w-1.5 h-1.5 bg-iris-accent rounded-full animate-pulse"></span>
                                        <span id="stepInfo" class="text-xs text-zinc-600 font-mono">Step 0/0</span>
                                    </div>
                                    <span id="etaInfo" class="text-xs text-zinc-600 font-mono">ETA: --</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Image Actions - Positioned above gallery -->
            <div id="imageActions" class="hidden absolute left-1/2 -translate-x-1/2 liquid-glass p-1.5 rounded-2xl flex items-center gap-1" style="z-index: 300; bottom: 196px;">
                <button type="button" onclick="downloadImage()" class="px-4 py-2 rounded-xl text-xs font-medium text-zinc-400 hover:bg-white/5 hover:text-white transition flex items-center gap-2 cursor-pointer">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    Download
                </button>
                <div class="w-px h-6 bg-white/10 mx-1"></div>
                <div class="relative">
                    <button type="button" id="upscaleBtn" onclick="showUpscaleOptions(event)" class="px-4 py-2 rounded-xl text-xs font-medium text-iris-accentLight hover:bg-iris-accent/10 transition flex items-center gap-2 cursor-pointer">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path></svg>
                        Upscale
                    </button>
                </div>
            </div>

            <!-- Bottom Gallery Panel -->
            <div class="h-[180px] bg-iris-panel border-t border-iris-border flex flex-col shrink-0">
                <div class="flex border-b border-iris-border px-4">
                    <button onclick="switchTab('recent')" class="tab-btn active px-4 py-2.5 text-[11px] font-semibold uppercase tracking-wider text-zinc-500" id="tab-recent">Session</button>
                    <button onclick="switchTab('output')" class="tab-btn px-4 py-2.5 text-[11px] font-semibold uppercase tracking-wider text-zinc-500" id="tab-output">Library</button>
                    <button onclick="switchTab('history')" class="tab-btn px-4 py-2.5 text-[11px] font-semibold uppercase tracking-wider text-zinc-500" id="tab-history">History</button>
                    <div class="flex-1 flex justify-end items-center">
                        <button onclick="refreshOutputGallery()" class="text-zinc-600 hover:text-white p-2 transition rounded-lg hover:bg-white/5">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        </button>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto p-3 custom-scrollbar bg-iris-bg/50">
                    <div id="content-recent" class="tab-content active h-full">
                        <div id="gallery" class="grid grid-cols-6 lg:grid-cols-8 xl:grid-cols-10 2xl:grid-cols-12 gap-2"></div>
                    </div>
                    <div id="content-output" class="tab-content h-full">
                        <div id="outputGallery" class="grid grid-cols-6 lg:grid-cols-8 xl:grid-cols-10 2xl:grid-cols-12 gap-2">
                            <div class="col-span-full text-center py-8 text-zinc-600 text-xs">Loading library...</div>
                        </div>
                    </div>
                    <div id="content-history" class="tab-content h-full">
                        <div class="flex justify-end mb-2">
                            <button onclick="clearPromptHistory()" class="text-[10px] text-red-400/70 hover:text-red-400 transition">Clear History</button>
                        </div>
                        <div id="promptHistory" class="space-y-2">
                            <div class="text-center py-8 text-zinc-600 text-xs">No history yet</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- === JAVASCRIPT === -->
    <script>
        // Tab Switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active', 'text-white'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active', 'active-block'));
            document.getElementById(`tab-${tabName}`).classList.add('active', 'text-white');
            const content = document.getElementById(`content-${tabName}`);
            content.classList.add(tabName === 'history' ? 'active-block' : 'active');
        }

        const API_URL = `${location.origin}/api`;
        const WS_URL = (location.protocol === "https:" ? "wss://" : "ws://") + location.host + "/ws/generate";
        
        let currentStyle = 'anime_kawai';
        let generating = false;
        let imageCounter = 0;
        let lastPrompt = '';
        let currentImageData = null;
        let ws = null;
        let seedLocked = false;
        let promptHistory = [];
        let generationNotification = null;
        let generationActive = false;
        let selectedUpscaleScale = 2;
        let timerInterval = null;
        let generationStartTime = null;

        const models = [
            { id: 'anime_kawai', name: 'Anime Kawaii Diffusion', image: '/assets/thumbnails/thumbnail-anime-kawaii-diffusion.webp' },
            { id: 'stable_diffusion_2_1', name: 'Stable Diffusion 2.1', image: '/assets/thumbnails/thumbnail-sd-2.1.webp' },
            { id: 'stable_diffusion_3_5', name: 'SD 3.5 Medium', image: '/assets/thumbnails/thumbnail-sd-3.5-medium.webp' },
            { id: 'flux_1_fast', name: 'Flux.1 Fast', image: '/assets/thumbnails/thumbnail-flux-fast.webp' },
            { id: 'openjourney', name: 'Openjourney', image: '/assets/thumbnails/thumbnail-openjourney.webp' },
            { id: 'pixel_art', name: 'Pixel Art Diffusion', image: '/assets/thumbnails/thumbnail-pixel-art-diffusion.webp' },
            { id: 'pony_diffusion', name: 'Pony Diffusion v6 XL', image: '/assets/thumbnails/thumbnail-pony-diffusion-v6-xl.webp' },
            { id: 'anything_v5', name: 'Anything v5', image: '/assets/thumbnails/thumbnail-anything-v5.webp' },
            { id: 'animagine_xl', name: 'Animagine XL 3.1', image: '/assets/thumbnails/thumbnail-animagine-xl-3.1.webp' },
            { id: 'aom3', name: 'AOM3', image: '/assets/thumbnails/thumbnail-aom3.webp' },
            { id: 'counterfeit_v3', name: 'Counterfeit v3.0', image: '/assets/thumbnails/thumbnail-counterfeit-v3.0.webp' },
        ];

        function initCustomDropdown() {
            const list = document.getElementById('modelDropdownList');
            list.innerHTML = '';
            models.forEach(model => {
                const item = document.createElement('div');
                item.className = 'p-2.5 hover:bg-iris-accent/10 cursor-pointer flex items-center gap-3 transition-colors border-b border-iris-border/50 last:border-0';
                item.onclick = () => selectModel(model.id);
                const imgHTML = model.image 
                    ? `<img src="${model.image}" class="w-10 h-10 rounded-lg object-cover bg-zinc-800 border border-white/5" alt="${model.name}" onerror="this.style.display='none'">`
                    : `<div class="w-10 h-10 rounded-lg bg-zinc-800 flex items-center justify-center text-xs text-zinc-500 font-mono border border-white/5">${model.name.substring(0,2).toUpperCase()}</div>`;
                item.innerHTML = `${imgHTML}<span class="text-sm text-zinc-300">${model.name}</span>`;
                list.appendChild(item);
            });
            document.addEventListener('click', (e) => {
                if (!document.getElementById('customModelDropdown').contains(e.target)) {
                    document.getElementById('modelDropdownList').classList.add('hidden');
                    document.getElementById('dropdownArrow').classList.remove('rotate-180');
                }
            });
        }

        function toggleModelDropdown() {
            document.getElementById('modelDropdownList').classList.toggle('hidden');
            document.getElementById('dropdownArrow').classList.toggle('rotate-180');
        }

        function selectModel(id) {
            currentStyle = id;
            document.getElementById('styleSelect').value = id;
            const model = models.find(m => m.id === id);
            if (model) {
                document.getElementById('selectedModelName').textContent = model.name;
                const imgPreview = document.getElementById('selectedModelPreview');
                if (model.image) {
                    imgPreview.style.backgroundImage = `url('${model.image}')`;
                    imgPreview.classList.remove('hidden');
                } else imgPreview.classList.add('hidden');
            }
            applyQualityPreset(document.getElementById('qualityPreset').value);
            saveSettings();
            document.getElementById('modelDropdownList').classList.add('hidden');
            document.getElementById('dropdownArrow').classList.remove('rotate-180');
        }

        function setVisualResolution(resValue, btnElement) {
            document.getElementById('resSelect').value = resValue;
            document.querySelectorAll('.aspect-btn').forEach(b => b.classList.remove('active'));
            if(btnElement) btnElement.classList.add('active');
            handleResolutionChange();
        }

        function toggleCustomRes() {
            document.getElementById('resSelect').value = 'custom';
            document.querySelectorAll('.aspect-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('customResBtn').classList.add('active');
            handleResolutionChange();
        }

        function showUpscaleOptions(event) {
            console.log('showUpscaleOptions called!');
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            const options = document.getElementById('upscaleOptions');
            const btn = document.getElementById('upscaleBtn');
            
            if (!options || !btn) {
                console.error('upscaleOptions or upscaleBtn not found!');
                return;
            }
            
            const isHidden = options.style.display === 'none' || options.style.display === '';
            
            if (isHidden) {
                // Position the popup above the button using fixed positioning
                const btnRect = btn.getBoundingClientRect();
                options.style.position = 'fixed';
                options.style.left = btnRect.left + 'px';
                options.style.top = (btnRect.top - 150) + 'px';
                options.style.zIndex = '99999';
                options.style.display = 'block';
                console.log('Popup positioned at:', btnRect.left, btnRect.top - 150);
            } else {
                options.style.display = 'none';
            }
            
            console.log('Upscale options toggled:', isHidden ? 'opened' : 'closed');
            console.log('currentImageData:', currentImageData);
        }
        
        // Close upscale options when clicking outside
        document.addEventListener('click', function(e) {
            const options = document.getElementById('upscaleOptions');
            const btn = document.getElementById('upscaleBtn');
            if (options && btn && !options.contains(e.target) && !btn.contains(e.target)) {
                options.style.display = 'none';
            }
        });
        
        function selectUpscaleScale(scale, btn) {
            selectedUpscaleScale = scale;
            document.querySelectorAll('.upscale-scale-btn').forEach(b => {
                b.classList.remove('active', 'bg-iris-accent/20', 'text-iris-accentLight', 'border-iris-accent/30');
                b.classList.add('bg-iris-card', 'text-zinc-500', 'border-iris-border');
            });
            btn.classList.remove('bg-iris-card', 'text-zinc-500', 'border-iris-border');
            btn.classList.add('active', 'bg-iris-accent/20', 'text-iris-accentLight', 'border-iris-accent/30');
        }
        
        function selectUpscaleMethod(method, element) {
            document.getElementById('upscaleMethod').value = method;
            document.querySelectorAll('.upscale-method-option').forEach(opt => {
                opt.classList.remove('active', 'bg-iris-accent/5');
            });
            element.classList.add('active', 'bg-iris-accent/5');
        }

        function loadPromptHistory() {
            try {
                const saved = localStorage.getItem('iris_prompt_history');
                if (saved) { promptHistory = JSON.parse(saved); updatePromptHistoryUI(); }
            } catch (e) { console.error('Error loading history:', e); }
        }

        function saveToPromptHistory(prompt, negativePrompt, seed, width, height, steps, cfg) {
            promptHistory.unshift({ prompt, negativePrompt, seed, resolution: `${width}x${height}`, steps, cfg, timestamp: new Date().toISOString() });
            if (promptHistory.length > 50) promptHistory = promptHistory.slice(0, 50);
            localStorage.setItem('iris_prompt_history', JSON.stringify(promptHistory));
            updatePromptHistoryUI();
        }

        function updatePromptHistoryUI() {
            const container = document.getElementById('promptHistory');
            if (promptHistory.length === 0) { container.innerHTML = '<div class="text-center py-8 text-zinc-600 text-xs">No history yet</div>'; return; }
            container.innerHTML = '';
            promptHistory.forEach((entry, index) => {
                const item = document.createElement('div');
                item.className = 'p-2.5 bg-iris-card border border-iris-border rounded-lg cursor-pointer hover:border-iris-accent/30 transition-all flex justify-between items-center group';
                item.onclick = () => loadFromHistory(index);
                const date = new Date(entry.timestamp);
                item.innerHTML = `<div class="flex-1 min-w-0 mr-3"><div class="text-xs text-zinc-400 truncate group-hover:text-iris-accentLight transition">${entry.prompt}</div><div class="flex gap-2 text-[10px] text-zinc-600 mt-1 font-mono"><span>${date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</span><span>${entry.resolution}</span></div></div><svg class="w-4 h-4 text-iris-accent opacity-0 group-hover:opacity-100 transition" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>`;
                container.appendChild(item);
            });
        }

        function loadFromHistory(index) {
            const entry = promptHistory[index];
            document.getElementById('promptInput').value = entry.prompt;
            document.getElementById('negativePromptInput').value = entry.negativePrompt;
            document.getElementById('seedInput').value = entry.seed;
            document.getElementById('resSelect').value = entry.resolution;
            document.getElementById('stepsSlider').value = entry.steps;
            document.getElementById('stepsValue').textContent = entry.steps;
            document.getElementById('cfgSlider').value = entry.cfg;
            document.getElementById('cfgValue').textContent = entry.cfg;
            handleResolutionChange();
        }

        function clearPromptHistory() {
            if (confirm('Clear all history?')) {
                promptHistory = [];
                localStorage.removeItem('iris_prompt_history');
                updatePromptHistoryUI();
            }
        }

        function showGenerationNotification(progress, step, total) {
            if (document.hidden && 'Notification' in window && Notification.permission === 'granted') {
                if (generationNotification) generationNotification.close();
                generationNotification = new Notification('I.R.I.S. Generation', { body: `Progress: ${progress}% (${step}/${total})`, tag: 'generation' });
            }
            if (document.hidden) document.title = `[${progress}%] I.R.I.S.`;
        }

        function showCompletedNotification(imageSrc) {
            if (document.hidden && 'Notification' in window && Notification.permission === 'granted') {
                if (generationNotification) generationNotification.close();
                const notification = new Notification('Generation Complete!', { body: 'Click to view', tag: 'completed' });
                notification.onclick = () => { window.focus(); notification.close(); };
            }
            document.title = 'I.R.I.S. Generator';
            generationNotification = null;
        }

        function loadSavedSettings() {
            try {
                const saved = localStorage.getItem('iris_settings');
                if (saved) {
                    const settings = JSON.parse(saved);
                    if (settings.style) selectModel(settings.style);
                    else selectModel('anime_kawai');
                    if (settings.quality) document.getElementById('qualityPreset').value = settings.quality;
                    if (settings.resolution) {
                        document.getElementById('resSelect').value = settings.resolution;
                        setVisualResolution(settings.resolution, null);
                        document.querySelectorAll('.aspect-btn').forEach(btn => {
                            if(btn.onclick && btn.onclick.toString().includes(settings.resolution)) btn.classList.add('active');
                        });
                        handleResolutionChange();
                    }
                    if (settings.steps) { document.getElementById('stepsSlider').value = settings.steps; document.getElementById('stepsValue').textContent = settings.steps; }
                    if (settings.cfg) { document.getElementById('cfgSlider').value = settings.cfg; document.getElementById('cfgValue').textContent = settings.cfg; }
                    if (settings.negativePrompt) document.getElementById('negativePromptInput').value = settings.negativePrompt;
                } else selectModel('anime_kawai');
            } catch (e) { console.error('Failed to load settings:', e); selectModel('anime_kawai'); }
            loadPromptHistory();
        }

        function saveSettings() {
            try {
                localStorage.setItem('iris_settings', JSON.stringify({
                    style: currentStyle,
                    quality: document.getElementById('qualityPreset').value,
                    resolution: document.getElementById('resSelect').value,
                    steps: parseInt(document.getElementById('stepsSlider').value),
                    cfg: parseFloat(document.getElementById('cfgSlider').value),
                    negativePrompt: document.getElementById('negativePromptInput').value
                }));
            } catch (e) { console.error('Failed to save settings:', e); }
        }

        function toggleSeedLock() {
            seedLocked = !seedLocked;
            const seedInput = document.getElementById('seedInput');
            const lockBtn = document.getElementById('seedLockBtn');
            const lockStatus = document.getElementById('seedLockStatus');
            if (seedLocked) {
                seedInput.readOnly = true;
                lockBtn.classList.add('text-iris-accent', 'bg-iris-accent/10', 'border-iris-accent/50');
                lockBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>';
                lockStatus.classList.remove('hidden');
            } else {
                seedInput.readOnly = false;
                lockBtn.classList.remove('text-iris-accent', 'bg-iris-accent/10', 'border-iris-accent/50');
                lockBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"></path></svg>';
                lockStatus.classList.add('hidden');
            }
        }

        function randomSeed(min = 1, max = 999_999) {
            if (seedLocked) return;

            document.getElementById('seedInput').value =
                Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // Custom Resolution Functions
        function swapCustomDimensions() {
            const widthInput = document.getElementById('customWidth');
            const heightInput = document.getElementById('customHeight');
            const temp = widthInput.value;
            widthInput.value = heightInput.value;
            heightInput.value = temp;
        }

        function setCustomPreset(width, height) {
            document.getElementById('customWidth').value = width;
            document.getElementById('customHeight').value = height;
        }

        // Generation Mode Dropdown
        let modeDropdownOpen = false;
        const modeConfigs = {
            fast: { name: 'Fast (Draft)', desc: '15 steps â€¢ Quick preview', steps: 15, cfg: 7, icon: 'emerald', iconSvg: '<svg class="w-4 h-4 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>' },
            balanced: { name: 'Balanced', desc: '35 steps â€¢ Good quality', steps: 35, cfg: 10, icon: 'iris-accent', iconSvg: '<svg class="w-4 h-4 text-iris-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>' },
            high: { name: 'High Quality', desc: '50 steps â€¢ Detailed output', steps: 50, cfg: 12, icon: 'amber', iconSvg: '<svg class="w-4 h-4 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg>' },
            extreme: { name: 'Extreme', desc: '100 steps â€¢ Maximum quality', steps: 100, cfg: 15, icon: 'red', iconSvg: '<svg class="w-4 h-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z"></path></svg>' }
        };

        function toggleModeDropdown() {
            modeDropdownOpen = !modeDropdownOpen;
            const dropdown = document.getElementById('modeDropdownList');
            const arrow = document.getElementById('modeDropdownArrow');
            dropdown.classList.toggle('hidden', !modeDropdownOpen);
            arrow.style.transform = modeDropdownOpen ? 'rotate(180deg)' : 'rotate(0deg)';
        }

        function selectMode(mode) {
            const config = modeConfigs[mode];
            document.getElementById('qualityPreset').value = mode;
            document.getElementById('selectedModeName').textContent = config.name;
            document.getElementById('selectedModeDesc').textContent = config.desc;
            document.getElementById('selectedModeIcon').innerHTML = config.iconSvg;
            
            // Update sliders
            document.getElementById('stepsSlider').value = config.steps;
            document.getElementById('stepsValue').textContent = config.steps;
            document.getElementById('cfgSlider').value = config.cfg;
            document.getElementById('cfgValue').textContent = config.cfg.toFixed(1);
            
            // Update active state in dropdown
            document.querySelectorAll('.mode-option').forEach(opt => opt.classList.remove('bg-iris-accent/5'));
            event.currentTarget.classList.add('bg-iris-accent/5');
            
            toggleModeDropdown();
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            const modeContainer = document.getElementById('modeDropdownContainer');
            if (modeContainer && !modeContainer.contains(e.target) && modeDropdownOpen) {
                toggleModeDropdown();
            }
        });

        function randomPrompt(category = "any") {
            const baseTags = "masterpiece, best quality, ultra-detailed, high resolution, cinematic lighting";

            const promptCategories = {
                anime: [
                    "1girl, anime girl, cyan hair, cat ears, fox tail, white tactical jacket, black pleated skirt, futuristic city, soft bokeh, glowing eyes",
                    "1girl, anime girl, long pink hair, school uniform, sunset sky, rooftop, wind blowing hair, emotional atmosphere",
                    "1girl, anime girl, short silver hair, headphones, oversized hoodie, night city, neon signs, lo-fi vibe",
                    "1girl, anime girl, twin tails, pastel colors, candy aesthetic, soft lighting, cute expression"
                ],

                cyberpunk: [
                    "1girl, cyberpunk, neon blue hair, tech armor, glowing circuit tattoos, night city, rain, neon reflections",
                    "1girl, cyberpunk hacker, short purple hair, visor glasses, holographic UI, dark alley, neon lights",
                    "1girl, cyberpunk samurai, katana, red neon lights, rainy street, dramatic pose"
                ],

                fantasy: [
                    "1girl, elf archer, silver hair, long braid, pointed ears, green leather armor, mystical forest, sunlight rays",
                    "1girl, witch, purple robe, wide wizard hat, floating spell circle, full moon, magic particles",
                    "1girl, dragon tamer, fiery eyes, red cloak, baby dragon on shoulder, volcanic background"
                ],

                sciFi: [
                    "1girl, space pilot, futuristic flight suit, galaxy background, stars, glowing cockpit lights",
                    "1girl, android, white synthetic skin, glowing blue eyes, sci-fi laboratory, clean aesthetic",
                    "1girl, mech operator, neural interface cables, giant robot hangar, cold lighting"
                ],

                realistic: [
                    "1girl, realistic portrait, soft window light, natural skin texture, shallow depth of field, 85mm lens",
                    "1girl, cinematic photography, black turtleneck, moody lighting, dark background",
                    "1girl, fashion shoot, modern streetwear, urban background, high contrast lighting"
                ],

                japanese: [
                    "1girl, kimono, floral pattern, black hair, hime cut, cherry blossoms, temple background, soft sunlight",
                    "1girl, shrine maiden, red and white outfit, torii gate, spiritual atmosphere",
                    "1girl, traditional yukata, summer festival, lanterns, night sky"
                ]
            };

            let selectedCategory;

            if (category === "any") {
                const keys = Object.keys(promptCategories);
                selectedCategory = keys[Math.floor(Math.random() * keys.length)];
            } else {
                selectedCategory = promptCategories[category] ? category : "anime";
            }

            const prompts = promptCategories[selectedCategory];
            const randomPrompt = prompts[Math.floor(Math.random() * prompts.length)];

            document.getElementById("promptInput").value = `${baseTags}, ${randomPrompt}`;
        }

        function applyQualityPreset(preset) {
            // This function is now called by selectMode() but kept for backwards compatibility
            const defaults = { fast: { steps: 15, cfg: 7.0 }, balanced: { steps: 35, cfg: 10.0 }, high: { steps: 50, cfg: 12.0 }, extreme: { steps: 100, cfg: 15.0 } };
            const modelConfigs = {
                'flux_1_fast': { fast: { steps: 4, cfg: 1.0 }, balanced: { steps: 8, cfg: 3.5 }, high: { steps: 12, cfg: 4.0 }, extreme: { steps: 20, cfg: 4.5 } },
                'pony_diffusion': { fast: { steps: 20, cfg: 5.0 }, balanced: { steps: 30, cfg: 7.0 }, high: { steps: 50, cfg: 8.0 }, extreme: { steps: 70, cfg: 9.0 } },
                'animagine_xl': { fast: { steps: 20, cfg: 5.0 }, balanced: { steps: 30, cfg: 7.0 }, high: { steps: 50, cfg: 8.0 }, extreme: { steps: 70, cfg: 9.0 } },
                'stable_diffusion_3_5': { fast: { steps: 20, cfg: 4.5 }, balanced: { steps: 35, cfg: 6.5 }, high: { steps: 50, cfg: 7.5 }, extreme: { steps: 70, cfg: 8.5 } },
                'stable_diffusion_2_1': { fast: { steps: 25, cfg: 7.0 }, balanced: { steps: 40, cfg: 9.0 }, high: { steps: 60, cfg: 10.0 }, extreme: { steps: 80, cfg: 12.0 } },
                'anything_v5': { fast: { steps: 20, cfg: 6.0 }, balanced: { steps: 28, cfg: 7.0 }, high: { steps: 45, cfg: 8.0 }, extreme: { steps: 60, cfg: 9.0 } }
            };
            const config = modelConfigs[currentStyle] ? modelConfigs[currentStyle][preset] : defaults[preset];
            if (config) {
                document.getElementById('stepsSlider').value = config.steps;
                document.getElementById('stepsValue').textContent = config.steps;
                document.getElementById('cfgSlider').value = config.cfg;
                document.getElementById('cfgValue').textContent = config.cfg.toFixed(1);
                
                // Update mode dropdown display
                if (modeConfigs[preset]) {
                    document.getElementById('selectedModeName').textContent = modeConfigs[preset].name;
                    document.getElementById('selectedModeDesc').textContent = `${config.steps} steps â€¢ CFG ${config.cfg}`;
                }
                
                saveSettings();
            }
        }

        function handleResolutionChange() {
            const resSelect = document.getElementById('resSelect');
            document.getElementById('customResContainer').classList.toggle('hidden', resSelect.value !== 'custom');
        }

        let lastProgressUpdate = 0;
        let simulatedProgress = 0;
        let progressSimulationInterval = null;
        
        function startProgressSimulation(totalSteps) {
            // Simuliere Progress basierend auf geschÃ¤tzter Zeit
            // Durchschnittlich ~1-2 Sekunden pro Step
            const estimatedTimePerStep = 1.5; // Sekunden
            const totalEstimatedTime = totalSteps * estimatedTimePerStep;
            const updateInterval = 100; // ms
            const progressPerUpdate = 100 / (totalEstimatedTime * 1000 / updateInterval);
            
            simulatedProgress = 0;
            
            if (progressSimulationInterval) clearInterval(progressSimulationInterval);
            
            progressSimulationInterval = setInterval(() => {
                if (!generationActive) {
                    clearInterval(progressSimulationInterval);
                    return;
                }
                
                // Langsamer werden wenn wir uns 90% nÃ¤hern (nie 100% erreichen bis fertig)
                const slowdownFactor = simulatedProgress > 80 ? 0.3 : simulatedProgress > 60 ? 0.6 : 1;
                simulatedProgress = Math.min(95, simulatedProgress + progressPerUpdate * slowdownFactor);
                
                const elapsed = (Date.now() - generationStartTime) / 1000;
                const estimatedStep = Math.floor((simulatedProgress / 100) * totalSteps);
                
                // Update UI
                document.getElementById('progressBar').style.width = `${simulatedProgress}%`;
                document.getElementById('progressPercent').textContent = `${Math.round(simulatedProgress)}%`;
                document.getElementById('stepInfo').textContent = `Step ~${estimatedStep}/${totalSteps}`;
                document.getElementById('timerCircle').style.strokeDashoffset = 364 * (1 - simulatedProgress / 100);
                
                // Update status text
                let statusText = 'Initializing...';
                if (simulatedProgress < 10) statusText = 'Loading model...';
                else if (simulatedProgress < 30) statusText = 'Warming up...';
                else if (simulatedProgress < 60) statusText = 'Generating details...';
                else if (simulatedProgress < 85) statusText = 'Refining image...';
                else statusText = 'Finishing up...';
                document.getElementById('generationStatus').textContent = statusText;
                
                document.getElementById('timerLabel').textContent = simulatedProgress < 30 ? 'WARMING UP' : simulatedProgress < 70 ? 'REFINING' : 'FINISHING';
                
                // ETA
                if (simulatedProgress > 5) {
                    const remainingProgress = 100 - simulatedProgress;
                    const timePerPercent = elapsed / simulatedProgress;
                    const eta = timePerPercent * remainingProgress;
                    document.getElementById('etaInfo').textContent = `ETA: ~${Math.max(1, Math.round(eta))}s`;
                }
                
                // Color progress bar
                const progressBar = document.getElementById('progressBar');
                if (simulatedProgress > 85) {
                    progressBar.style.background = 'linear-gradient(90deg, #10b981, #34d399)';
                } else if (simulatedProgress > 50) {
                    progressBar.style.background = 'linear-gradient(90deg, #8b5cf6, #6366f1)';
                } else {
                    progressBar.style.background = 'linear-gradient(90deg, #8b5cf6, #a78bfa)';
                }
            }, updateInterval);
        }
        
        function stopProgressSimulation() {
            if (progressSimulationInterval) {
                clearInterval(progressSimulationInterval);
                progressSimulationInterval = null;
            }
        }
        
        function updateProgress(data) {
            // Falls der Server echte Progress-Updates sendet, nutze diese
            if (generationActive && generationStartTime && data.progress !== undefined) {
                stopProgressSimulation(); // Stoppe Simulation wenn echte Daten kommen
                
                const elapsed = (Date.now() - generationStartTime) / 1000;
                const progress = data.progress || 0;
                const step = data.step || 0;
                const totalSteps = data.total_steps || 0;
                
                document.getElementById('timerDisplay').textContent = elapsed.toFixed(1) + 's';
                document.getElementById('stepInfo').textContent = `Step ${step}/${totalSteps}`;
                document.getElementById('progressBar').style.width = `${progress}%`;
                document.getElementById('progressPercent').textContent = `${Math.round(progress)}%`;
                
                if (totalSteps > 0) {
                    document.getElementById('timerCircle').style.strokeDashoffset = 364 * (1 - progress / 100);
                }
                
                let statusText = 'Initializing...';
                if (progress < 10) statusText = 'Loading model...';
                else if (progress < 30) statusText = 'Warming up...';
                else if (progress < 60) statusText = 'Generating details...';
                else if (progress < 85) statusText = 'Refining image...';
                else statusText = 'Finishing up...';
                document.getElementById('generationStatus').textContent = statusText;
                
                document.getElementById('timerLabel').textContent = progress < 30 ? 'WARMING UP' : progress < 70 ? 'REFINING' : 'FINISHING';
                
                if (step > 0 && totalSteps > 0) {
                    const timePerStep = elapsed / step;
                    const remainingSteps = totalSteps - step;
                    const eta = timePerStep * remainingSteps;
                    document.getElementById('etaInfo').textContent = `ETA: ${eta.toFixed(1)}s`;
                }
                
                const progressBar = document.getElementById('progressBar');
                if (progress > 85) {
                    progressBar.style.background = 'linear-gradient(90deg, #10b981, #34d399)';
                } else if (progress > 50) {
                    progressBar.style.background = 'linear-gradient(90deg, #8b5cf6, #6366f1)';
                } else {
                    progressBar.style.background = 'linear-gradient(90deg, #8b5cf6, #a78bfa)';
                }
                
                showGenerationNotification(Math.floor(progress), step, totalSteps);
                lastProgressUpdate = Date.now();
            }
        }

        function handleCompletion(data) {
            stopProgressSimulation();
            if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
            const finalTime = data.generation_time || (Date.now() - generationStartTime) / 1000;
            
            // Update all progress indicators to 100%
            document.getElementById('timerDisplay').textContent = finalTime.toFixed(1) + 's';
            document.getElementById('timerLabel').textContent = 'COMPLETE';
            document.getElementById('generationStatus').textContent = 'âœ¨ Generation complete!';
            document.getElementById('timerCircle').style.strokeDashoffset = 0;
            document.getElementById('progressBar').style.width = '100%';
            document.getElementById('progressBar').style.background = 'linear-gradient(90deg, #10b981, #34d399)';
            document.getElementById('progressPercent').textContent = '100%';
            document.getElementById('etaInfo').textContent = `Done in ${finalTime.toFixed(1)}s`;
            
            lastPrompt = document.getElementById('promptInput').value;
            const resSelect = document.getElementById('resSelect');
            let width, height;
            if (resSelect.value === 'custom') { width = parseInt(document.getElementById('customWidth').value); height = parseInt(document.getElementById('customHeight').value); }
            else [width, height] = resSelect.value.split('x').map(Number);
            
            saveToPromptHistory(lastPrompt, document.getElementById('negativePromptInput').value, data.seed, width, height, parseInt(document.getElementById('stepsSlider').value), parseFloat(document.getElementById('cfgSlider').value));
            showCompletedNotification(data.image);
            
            // 2.5 Sekunden Delay damit der Balken auf 100% animieren kann
            setTimeout(() => {
                finishGeneration(data);
                if (ws) { ws.close(); ws = null; }
                generationActive = false;
            }, 2500);
        }

        function handleError(data) {
            stopProgressSimulation();
            alert('Error: ' + (data.message || 'Unknown error'));
            resetUI();
            if (ws) { ws.close(); ws = null; }
            generationActive = false;
        }

        async function generateImage() {
            if (generating) return;
            if (ws && ws.readyState !== WebSocket.CLOSED) { ws.close(); ws = null; }
            let width, height;
            const resSelect = document.getElementById('resSelect');
            if (resSelect.value === 'custom') {
                width = parseInt(document.getElementById('customWidth').value);
                height = parseInt(document.getElementById('customHeight').value);
                if (!width || !height) return alert('Invalid dimensions');
            } else [width, height] = resSelect.value.split('x').map(Number);
            
            const megapixels = (width * height) / 1000000;
            if (megapixels > 2 && !confirm('High resolution may take time. Continue?')) return;
            
            saveSettings();
            generating = true;
            generationActive = true;
            
            const btn = document.getElementById('generateBtn');
            btn.disabled = true;
            btn.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Processing...</span>';
            
            document.getElementById('gpuStatusDot').className = 'w-2 h-2 rounded-full bg-iris-accent animate-pulse';
            document.getElementById('gpuStatusText').textContent = 'Generating';
            document.getElementById('placeholderText').classList.add('hidden');
            document.getElementById('previewImage').classList.add('opacity-50');
            document.getElementById('progressContainer').classList.remove('hidden');
            
            generationStartTime = Date.now();
            document.getElementById('timerDisplay').textContent = '0.0s';
            document.getElementById('timerLabel').textContent = 'INITIALIZING';
            document.getElementById('generationStatus').textContent = 'Initializing...';
            document.getElementById('stepInfo').textContent = 'Step 0/0';
            document.getElementById('timerCircle').style.strokeDashoffset = 364;
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressBar').style.background = 'linear-gradient(90deg, #8b5cf6, #a78bfa)';
            document.getElementById('progressPercent').textContent = '0%';
            document.getElementById('etaInfo').textContent = 'ETA: calculating...';
            
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (generationActive && generationStartTime) document.getElementById('timerDisplay').textContent = ((Date.now() - generationStartTime) / 1000).toFixed(1) + 's';
            }, 100);
            
            const prompt = document.getElementById('promptInput').value;
            lastPrompt = prompt;
            let seed = null;
            const seedInputVal = document.getElementById('seedInput').value;
            if (seedInputVal !== '-1' && seedInputVal !== '') seed = parseInt(seedInputVal);
            
            const steps = parseInt(document.getElementById('stepsSlider').value);
            
            const settings = {
                prompt, negative_prompt: document.getElementById('negativePromptInput').value,
                style: currentStyle, seed, steps: steps,
                cfg_scale: parseFloat(document.getElementById('cfgSlider').value), width, height, nsfw_filter_enabled: true
            };
            
            // Starte Progress-Simulation
            startProgressSimulation(steps);
            
            try {
                ws = new WebSocket(WS_URL);
                ws.onopen = () => ws.send(JSON.stringify(settings));
                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    if (data.type === 'progress') updateProgress(data);
                    else if (data.type === 'completed') handleCompletion(data);
                    else if (data.type === 'started') {
                        // Server hat gestartet - Progress-Simulation lÃ¤uft bereits
                        document.getElementById('generationStatus').textContent = 'Generating...';
                    }
                    else if (data.type === 'warning') { if (data.nsfw_blocked) { alert('ðŸ›¡ï¸ Safety Filter Active\n\n' + data.message); resetUI(); } }
                    else if (data.type === 'error') handleError(data);
                };
                ws.onerror = () => { alert('Connection Error'); resetUI(); };
                ws.onclose = () => { if (generating) resetUI(); };
            } catch (e) { resetUI(); }
        }

        function resetUI() {
            stopProgressSimulation();
            generating = false;
            generationActive = false;
            if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
            generationStartTime = null;
            const btn = document.getElementById('generateBtn');
            btn.disabled = false;
            btn.innerHTML = '<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg><span>Generate</span>';
            document.getElementById('gpuStatusDot').className = 'w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.6)]';
            document.getElementById('gpuStatusText').textContent = 'Ready';
            document.getElementById('progressContainer').classList.add('hidden');
            document.getElementById('previewImage').classList.remove('opacity-50');
        }

        function finishGeneration(data) {
            currentImageData = data;
            document.getElementById('placeholderText').classList.add('hidden');
            document.getElementById('progressContainer').classList.add('hidden');
            const img = document.getElementById('previewImage');
            img.onload = () => { img.classList.remove('hidden', 'opacity-50'); };
            img.src = data.image;
            img.dataset.filename = data.filename;
            document.getElementById('imageActions').classList.remove('hidden');
            imageCounter++;
            document.getElementById('imageCount').textContent = imageCounter;
            document.getElementById('imageInfo').textContent = `Seed: ${data.seed} â€¢ ${data.generation_time.toFixed(1)}s â€¢ ${data.width}Ã—${data.height}`;
            if (data.seed && !seedLocked) document.getElementById('seedInput').value = data.seed;
            resetUI();
            addToGallery(data.image, data.filename, lastPrompt, data.seed);
            refreshOutputGallery();
        }

        function addToGallery(imageSrc, filename, prompt, seed) {
            const gallery = document.getElementById('gallery');
            const container = document.createElement('div');
            container.className = 'aspect-square rounded-lg overflow-hidden border border-iris-border cursor-pointer hover:border-iris-accent/50 transition relative group bg-iris-card';
            container.onclick = () => showImage(imageSrc, filename, prompt, seed);
            container.innerHTML = `<img src="${imageSrc}" class="w-full h-full object-cover"><div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center"><svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg></div>`;
            gallery.prepend(container);
            if(gallery.children.length > 24) gallery.removeChild(gallery.lastChild);
        }

        function showImage(src, filename, prompt, seed) {
            const img = document.getElementById('previewImage');
            img.src = src;
            img.dataset.filename = filename;
            img.classList.remove('hidden');
            document.getElementById('placeholderText').classList.add('hidden');
            document.getElementById('imageActions').classList.remove('hidden');
            document.getElementById('imageInfo').textContent = `Seed: ${seed} (History)`;
            currentImageData = { image: src, filename, seed };
        }

        function downloadImage() {
            const img = document.getElementById('previewImage');
            const link = document.createElement('a');
            link.href = img.src;
            link.download = img.dataset.filename || 'generated_image.png';
            link.click();
        }

        async function upscaleImage() {
            if (!currentImageData || !currentImageData.filename) {
                alert('Kein Bild ausgewÃ¤hlt oder Dateiname fehlt');
                return;
            }
            
            const btn = document.getElementById('upscaleBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
            
            try {
                const response = await fetch(API_URL + '/upscale', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filename: currentImageData.filename,
                        scale: selectedUpscaleScale,
                        method: document.getElementById('upscaleMethod').value
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('previewImage').src = data.image;
                    currentImageData.filename = data.filename;
                    currentImageData.image = data.image;
                    document.getElementById('imageInfo').textContent = `Upscaled ${data.method} ${selectedUpscaleScale}x â€¢ ${data.new_size[0]}Ã—${data.new_size[1]}`;
                    addToGallery(data.image, data.filename, 'Upscaled', currentImageData.seed || '?');
                } else {
                    alert('Upscale fehlgeschlagen: ' + (data.detail || data.error || 'Unbekannter Fehler'));
                }
            } catch (e) {
                console.error('Upscale error:', e);
                alert('Verbindung fehlgeschlagen');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
                document.getElementById('upscaleOptions').style.display = 'none';
            }
        }

        async function refreshOutputGallery() {
            try {
                const response = await fetch(API_URL + '/output-gallery');
                const data = await response.json();
                const gallery = document.getElementById('outputGallery');
                if (!data.images || data.images.length === 0) { gallery.innerHTML = '<div class="col-span-full text-center py-8 text-zinc-600 text-xs">No images found</div>'; return; }
                gallery.innerHTML = '';
                data.images.forEach(filename => {
                    const container = document.createElement('div');
                    container.className = 'aspect-square rounded-lg overflow-hidden border border-iris-border cursor-pointer hover:border-iris-accent/50 transition relative group bg-iris-card';
                    const img = document.createElement('img');
                    img.loading = 'lazy';
                    img.src = API_URL + `/output-image/${filename}`;
                    img.className = 'w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity';
                    container.onclick = () => showImage(img.src, filename, 'Library Image', '?');
                    container.appendChild(img);
                    gallery.appendChild(container);
                });
            } catch (e) { console.error(e); }
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            initCustomDropdown();
            loadSavedSettings();
            randomSeed();
            refreshOutputGallery();
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey && document.activeElement.tagName !== 'TEXTAREA' && !generating) generateImage();
            });
        });
    </script>
    
    <!-- Upscale Options Popup - placed at body level for proper z-index -->
    <div id="upscaleOptions" class="liquid-glass border border-iris-border rounded-xl shadow-2xl" style="display: none; position: fixed; z-index: 99999; min-width: 280px;">
        <!-- Method Selection -->
        <div class="p-3 border-b border-iris-border/50">
            <label class="block text-[10px] text-zinc-500 uppercase font-semibold mb-2">Upscale Method</label>
            <div id="upscaleMethodOptions">
                <div onclick="selectUpscaleMethod('lanczos', this)" class="upscale-method-option active flex items-center gap-3 p-2.5 rounded-lg hover:bg-iris-accent/10 cursor-pointer transition-colors mb-1.5">
                    <div class="w-8 h-8 rounded-lg bg-emerald-500/20 flex items-center justify-center">
                        <svg class="w-4 h-4 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    </div>
                    <div>
                        <span class="font-medium text-zinc-200 block text-sm">Lanczos</span>
                        <span class="text-[10px] text-zinc-500">Fast â€¢ Good quality</span>
                    </div>
                </div>
                <div onclick="selectUpscaleMethod('realesrgan', this)" class="upscale-method-option flex items-center gap-3 p-2.5 rounded-lg hover:bg-iris-accent/10 cursor-pointer transition-colors">
                    <div class="w-8 h-8 rounded-lg bg-iris-accent/20 flex items-center justify-center">
                        <svg class="w-4 h-4 text-iris-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg>
                    </div>
                    <div>
                        <span class="font-medium text-zinc-200 block text-sm">Real-ESRGAN</span>
                        <span class="text-[10px] text-zinc-500">AI Enhanced â€¢ Best quality</span>
                    </div>
                </div>
            </div>
            <input type="hidden" id="upscaleMethod" value="lanczos">
        </div>
        
        <!-- Scale Selection -->
        <div class="p-3 border-b border-iris-border/50">
            <label class="block text-[10px] text-zinc-500 uppercase font-semibold mb-2">Scale Factor</label>
            <div class="flex gap-2">
                <button type="button" onclick="selectUpscaleScale(2, this)" class="upscale-scale-btn active flex-1 py-2.5 rounded-lg text-sm font-medium cursor-pointer transition-all bg-iris-accent/20 text-iris-accentLight border border-iris-accent/30">2x</button>
                <button type="button" onclick="selectUpscaleScale(4, this)" class="upscale-scale-btn flex-1 py-2.5 rounded-lg text-sm font-medium cursor-pointer transition-all bg-iris-card text-zinc-500 border border-iris-border hover:bg-white/5 hover:text-zinc-300">4x</button>
            </div>
        </div>
        
        <!-- Apply Button -->
        <div class="p-3">
            <button type="button" onclick="upscaleImage()" class="w-full py-2.5 rounded-xl font-semibold text-sm text-white bg-gradient-to-r from-iris-accent to-indigo-500 hover:from-iris-accent/90 hover:to-indigo-500/90 transition-all flex items-center justify-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path></svg>
                Apply Upscale
            </button>
        </div>
    </div>
</body>
</html>
