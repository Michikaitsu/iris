<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I.R.I.S. Generator (Leonardo Style)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/png" href="/assets/favicon.png">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        leo: {
                            bg: '#0b0f19',       // Main Background
                            panel: '#161b22',    // Sidebar/Panel Background
                            input: '#21262d',    // Input Background
                            border: '#30363d',   // Border Color
                            accent: '#8b5cf6',   // Primary Accent (Purple/Indigo style)
                            accentHover: '#7c3aed',
                            text: '#c9d1d9',
                            textMuted: '#8b949e'
                        }
                    },
                    backgroundImage: {
                        'gradient-leo': 'linear-gradient(135deg, #B249F8 0%, #5B4AF5 100%)', // Leonardo-like gradient
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --bg-dark: #0b0f19;
            --panel-bg: #161b22;
        }

        body {
            background-color: var(--bg-dark);
            color: #c9d1d9;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- Scrollbars --- */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #484f58; }

        /* --- UI Components --- */
        .input-group {
            background: #21262d;
            border: 1px solid #30363d;
            transition: all 0.2s ease;
        }
        
        .input-group:focus-within {
            border-color: #58a6ff;
            box-shadow: 0 0 0 1px #58a6ff;
        }

        .leo-select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%238b949e' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1em;
        }

        select option {
            background-color: #161b22;
            color: #c9d1d9;
            padding: 10px;
        }

        /* Sliders */
        input[type="range"] {
            -webkit-appearance: none;
            background: transparent;
            height: 4px;
            border-radius: 2px;
            background: #30363d;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #ffffff;
            margin-top: -6px;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            transition: transform 0.1s;
        }
        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            background: #B249F8;
        }

        /* Generate Button */
        .btn-generate {
            background: linear-gradient(90deg, #d946ef 0%, #8b5cf6 100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-generate:hover:not(:disabled) {
            transform: translateY(-1px);
            filter: brightness(1.1);
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.4);
        }
        .btn-generate:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            filter: grayscale(0.8);
        }

        /* Checkerboard */
        .checkerboard-bg {
            background-color: #0d1117;
            background-image:
                linear-gradient(45deg, #161b22 25%, transparent 25%),
                linear-gradient(-45deg, #161b22 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #161b22 75%),
                linear-gradient(-45deg, transparent 75%, #161b22 75%);
            background-size: 20px 20px;
        }

        /* Aspect Ratio Buttons */
        .aspect-btn {
            border: 1px solid #30363d;
            background: #21262d;
            color: #8b949e;
            transition: all 0.2s;
        }
        .aspect-btn:hover {
            background: #30363d;
            color: #c9d1d9;
        }
        .aspect-btn.active {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
            color: #fff;
        }
        .aspect-preview {
            border: 2px solid currentColor;
            border-radius: 2px;
        }

        /* Tabs */
        .tab-btn.active {
            color: #fff;
            border-bottom-color: #8b5cf6;
        }
        .tab-content { display: none; }
        .tab-content.active, .tab-content.active-block { display: block; }

        /* Animation */
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        .loading-bar-inner {
            position: absolute;
            top: 0; left: 0; bottom: 0;
            width: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transform: translateX(-100%);
            animation: shimmer 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { 
                transform: scale(1);
                opacity: 1;
            }
            50% { 
                transform: scale(1.05);
                opacity: 0.8;
            }
        }
    </style>
</head>
<body class="text-sm selection:bg-purple-500/30 selection:text-purple-100">

    <div class="flex h-full w-full overflow-hidden">
        
        <!-- === SIDEBAR === -->
        <aside class="w-[340px] md:w-[380px] flex flex-col border-r border-leo-border bg-leo-panel flex-shrink-0 z-20 shadow-2xl">
            
            <!-- Logo Header -->
            <div class="h-16 flex items-center px-5 border-b border-leo-border bg-leo-panel">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center shadow-lg">
                        <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg tracking-tight text-white leading-none">I.R.I.S.</h1>
                        <span class="text-[10px] font-mono text-purple-400 tracking-wider">AI CANVAS</span>
                    </div>
                </div>
            </div>

            <!-- Navigation Menu -->
            <nav class="px-2 py-3 border-b border-leo-border flex gap-1">
                <a href="/" class="flex-1 px-3 py-2 text-center text-xs font-semibold rounded-lg transition-all hover:bg-leo-input text-gray-300 hover:text-white" title="Home">
                    <svg class="w-4 h-4 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-3m0 0l7-4 7 4M5 9v7a1 1 0 001 1h12a1 1 0 001-1V9m-9 16l-7-4m0 0V5m7 4l7-4m0 0v12m0 0l7 4m-7-4v0"></path></svg>
                    Home
                </a>
                <a href="/generate" class="flex-1 px-3 py-2 text-center text-xs font-semibold rounded-lg transition-all bg-leo-input text-purple-400 border border-purple-500/50" title="Generate">
                    <svg class="w-4 h-4 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    Generate
                </a>
                <a href="/gallery" class="flex-1 px-3 py-2 text-center text-xs font-semibold rounded-lg transition-all hover:bg-leo-input text-gray-300 hover:text-white" title="Gallery">
                    <svg class="w-4 h-4 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    Gallery
                </a>
                <a href="/settings" class="flex-1 px-3 py-2 text-center text-xs font-semibold rounded-lg transition-all hover:bg-leo-input text-gray-300 hover:text-white" title="Settings">
                    <svg class="w-4 h-4 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    Settings
                </a>
            </nav>

            <!-- Scrollable Controls -->
            <div class="flex-1 overflow-y-auto custom-scrollbar">
                <div class="p-5 space-y-6">

                    <!-- 1. MODEL / STYLE SELECTOR (CUSTOM DROPDOWN) -->
                    <div class="space-y-2">
                        <label class="text-xs font-semibold text-leo-textMuted uppercase tracking-wider flex items-center gap-2">
                            <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            Fine-tuned Model
                        </label>
                        
                        <!-- Custom Dropdown Container -->
                        <div class="relative" id="customModelDropdown">
                            <!-- Trigger Button -->
                            <button type="button" onclick="toggleModelDropdown()" class="w-full bg-leo-input border border-leo-border rounded-lg text-sm text-white p-2.5 flex items-center justify-between hover:border-purple-500 transition-colors group focus:outline-none focus:ring-1 focus:ring-purple-500/50">
                                <div class="flex items-center gap-3 overflow-hidden">
                                    <div id="selectedModelPreview" class="w-8 h-8 rounded bg-gray-800 flex-shrink-0 bg-cover bg-center hidden"></div>
                                    <span id="selectedModelName" class="truncate font-medium">Select Model</span>
                                </div>
                                <svg id="dropdownArrow" class="w-4 h-4 text-gray-500 group-hover:text-white transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>

                            <!-- Dropdown Menu -->
                            <div id="modelDropdownList" class="hidden absolute top-full left-0 right-0 mt-2 bg-[#161b22] border border-leo-border rounded-lg shadow-2xl z-50 max-h-[320px] overflow-y-auto custom-scrollbar ring-1 ring-black/50">
                                <!-- Items generated by JS -->
                            </div>

                            <!-- Hidden Input for Form/Logic Compatibility -->
                            <input type="hidden" id="styleSelect" value="anime_kawai">
                        </div>
                    </div>

                    <!-- 2. PROMPT SECTION -->
                    <div class="space-y-2">
                        <div class="flex justify-between items-end">
                            <label class="text-xs font-semibold text-leo-textMuted uppercase tracking-wider flex items-center gap-2">
                                <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                Prompt
                            </label>
                            <div class="flex gap-1">
                                <button onclick="randomPrompt()" class="p-1.5 rounded hover:bg-white/10 text-leo-textMuted hover:text-white transition" title="Random Prompt">
                                    <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                                </button>
                            </div>
                        </div>
                        <div class="input-group rounded-xl overflow-hidden shadow-sm relative group">
                            <textarea id="promptInput" class="w-full bg-leo-input border-none text-white p-3 text-sm focus:ring-0 resize-y min-h-[120px] placeholder-gray-600 leading-relaxed custom-scrollbar" placeholder="Type a detailed description of the image you want to generate...">masterpiece, best quality, ultra-detailed, high resolution, cinematic lighting, 1girl, anime girl with cyan hair, cat ears, fox tail, wearing white tactical jacket, black pleated skirt, futuristic city background, soft bokeh, glowing eyes, highly intricate details</textarea>
                            <div class="absolute bottom-2 right-2 text-[10px] text-gray-600 pointer-events-none group-focus-within:text-purple-500">AI Prompt</div>
                        </div>

                        <!-- 3. NEGATIVE PROMPT (Dropdown below prompt) -->
                        <div class="pt-1">
                            <details class="group/neg">
                                <summary class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-white/5 transition-colors select-none">
                                    <div class="text-leo-textMuted group-open/neg:text-red-400 transition-colors">
                                        <svg class="w-4 h-4 transition-transform group-open/neg:rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                                    </div>
                                    <span class="text-xs font-medium text-leo-textMuted group-open/neg:text-white">Add Negative Prompt</span>
                                </summary>
                                <div class="mt-2 pl-2">
                                    <textarea id="negativePromptInput" class="w-full bg-leo-input border border-leo-border rounded-lg text-gray-300 p-2 text-xs h-20 focus:border-red-500/50 focus:ring-1 focus:ring-red-500/50 resize-none placeholder-gray-600" placeholder="What do you want to avoid? (e.g. ugly, blurry, deformed)">lowres, bad anatomy, bad hands, text, error, missing fingers, extra digit, fewer digits, cropped, worst quality, low quality, normal quality, jpeg artifacts, signature, watermark, username, blurry, out of focus, duplicate, ugly, morbid, mutilated, mutated hands, poorly drawn face, mutation, deformed, dehydrated, bad proportions, gross proportions, malformed limbs, long neck</textarea>
                                </div>
                            </details>
                        </div>
                    </div>

                    <div class="h-px bg-leo-border w-full my-4"></div>

                    <!-- 4. IMAGE DIMENSIONS (Visual Grid) -->
                    <div class="space-y-3">
                        <label class="text-xs font-semibold text-leo-textMuted uppercase tracking-wider flex items-center gap-2">
                            <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            Image Dimensions
                        </label>
                        
                        <!-- Visual Buttons -->
                        <div class="grid grid-cols-4 gap-2">
                            <button type="button" onclick="setVisualResolution('512x512', this)" class="aspect-btn active rounded-lg p-2 flex flex-col items-center gap-1.5" title="1:1 Square">
                                <div class="aspect-preview w-4 h-4"></div>
                                <span class="text-[10px] font-medium">1:1</span>
                            </button>
                            <button type="button" onclick="setVisualResolution('512x768', this)" class="aspect-btn rounded-lg p-2 flex flex-col items-center gap-1.5" title="2:3 Portrait">
                                <div class="aspect-preview w-3 h-5"></div>
                                <span class="text-[10px] font-medium">2:3</span>
                            </button>
                            <button type="button" onclick="setVisualResolution('768x512', this)" class="aspect-btn rounded-lg p-2 flex flex-col items-center gap-1.5" title="3:2 Landscape">
                                <div class="aspect-preview w-5 h-3"></div>
                                <span class="text-[10px] font-medium">3:2</span>
                            </button>
                            <button type="button" onclick="setVisualResolution('768x1024', this)" class="aspect-btn rounded-lg p-2 flex flex-col items-center gap-1.5" title="3:4 Portrait">
                                <div class="aspect-preview w-3.5 h-5"></div>
                                <span class="text-[10px] font-medium">3:4</span>
                            </button>
                            <button type="button" onclick="setVisualResolution('1024x768', this)" class="aspect-btn rounded-lg p-2 flex flex-col items-center gap-1.5" title="4:3 Landscape">
                                <div class="aspect-preview w-5 h-3.5"></div>
                                <span class="text-[10px] font-medium">4:3</span>
                            </button>
                            <button type="button" onclick="setVisualResolution('720x1280', this)" class="aspect-btn rounded-lg p-2 flex flex-col items-center gap-1.5" title="9:16 Mobile">
                                <div class="aspect-preview w-2.5 h-5"></div>
                                <span class="text-[10px] font-medium">9:16</span>
                            </button>
                            <button type="button" onclick="setVisualResolution('1080x1920', this)" class="aspect-btn rounded-lg p-2 flex flex-col items-center gap-1.5" title="9:16 HD">
                                <div class="aspect-preview w-2.5 h-5"></div>
                                <span class="text-[10px] font-medium">9:16 HD</span>
                            </button>
                            <button type="button" onclick="toggleCustomRes()" id="customResBtn" class="aspect-btn rounded-lg p-2 flex flex-col items-center gap-1.5" title="Custom">
                                <svg class="w-4 h-4 mb-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                                <span class="text-[10px] font-medium">Custom</span>
                            </button>
                        </div>

                        <!-- Original Hidden Select (Kept for Logic Compatibility) -->
                        <select id="resSelect" onchange="handleResolutionChange()" class="hidden">
                            <option value="512x512">1:1 (512x512)</option>
                            <option value="512x768">2:3 (512x768)</option>
                            <option value="768x512">3:2 (768x512)</option>
                            <option value="768x768">1:1 (768x768)</option>
                            <option value="1024x768">4:3 (1024x768)</option>
                            <option value="768x1024">3:4 (768x1024)</option>
                            <option value="1024x1024">1:1 HD (1024x1024)</option>
                            <option value="720x1280">9:16 (720x1280)</option>
                            <option value="1080x1920">9:16 HD (1080x1920)</option>
                            <option value="1280x1280">High Res (1280x1280)</option>
                            <option value="custom">Custom</option>
                        </select>

                        <!-- Custom Inputs (Appears on click) -->
                        <div id="customResContainer" class="hidden pt-2 animate-in slide-in-from-top-2 fade-in duration-200">
                            <div class="flex items-center gap-2 p-3 bg-leo-input border border-leo-border rounded-lg">
                                <div class="flex-1">
                                    <label class="text-[10px] text-gray-500 uppercase block mb-1">Width</label>
                                    <input type="number" id="customWidth" placeholder="512" min="64" max="2048" class="bg-leo-bg border border-leo-border rounded px-2 py-1 w-full text-white text-xs font-mono focus:border-purple-500 focus:outline-none">
                                </div>
                                <span class="text-gray-600 mt-4">Ã—</span>
                                <div class="flex-1">
                                    <label class="text-[10px] text-gray-500 uppercase block mb-1">Height</label>
                                    <input type="number" id="customHeight" placeholder="512" min="64" max="2048" class="bg-leo-bg border border-leo-border rounded px-2 py-1 w-full text-white text-xs font-mono focus:border-purple-500 focus:outline-none">
                                </div>
                            </div>
                        </div>

                        <!-- Generation Mode (Quality) -->
                         <div class="mt-4">
                            <label class="text-xs font-semibold text-leo-textMuted uppercase tracking-wider block mb-2">Generation Mode</label>
                            <div class="relative">
                                <select id="qualityPreset" onchange="applyQualityPreset(this.value)" class="leo-select w-full bg-leo-input border border-leo-border rounded-lg text-sm text-white p-2.5 cursor-pointer focus:border-purple-500 focus:ring-1 focus:ring-purple-500 outline-none">
                                    <option value="fast">Fast (Draft)</option>
                                    <option value="balanced" selected>Balanced</option>
                                    <option value="high">High Quality</option>
                                    <option value="extreme">Extreme</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="h-px bg-leo-border w-full my-4"></div>

                    <!-- 5. ADVANCED SETTINGS (Steps, CFG, Seed) -->
                    <details class="group">
                        <summary class="flex justify-between items-center cursor-pointer py-2 text-xs font-semibold text-leo-textMuted hover:text-white transition-colors select-none">
                            <div class="flex items-center gap-2">
                                <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                <span>Advanced Settings</span>
                            </div>
                            <svg class="w-4 h-4 transition-transform group-open:rotate-180 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </summary>
                        
                        <div class="pt-4 space-y-6 animate-in slide-in-from-top-1 fade-in duration-200">
                            <!-- Steps -->
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <label class="text-[10px] uppercase text-gray-500 font-bold">Sampling Steps</label>
                                    <span id="stepsValue" class="text-[10px] font-mono text-purple-400 bg-purple-900/30 px-1.5 rounded border border-purple-500/30">35</span>
                                </div>
                                <input id="stepsSlider" type="range" min="1" max="150" value="35" class="w-full accent-purple-500" oninput="document.getElementById('stepsValue').textContent = this.value">
                            </div>

                            <!-- CFG -->
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <label class="text-[10px] uppercase text-gray-500 font-bold">CFG Scale</label>
                                    <span id="cfgValue" class="text-[10px] font-mono text-purple-400 bg-purple-900/30 px-1.5 rounded border border-purple-500/30">10.0</span>
                                </div>
                                <input id="cfgSlider" type="range" min="1" max="20" step="0.1" value="10" class="w-full accent-purple-500" oninput="document.getElementById('cfgValue').textContent = parseFloat(this.value).toFixed(1)">
                            </div>

                            <!-- Seed -->
                            <div class="space-y-2">
                                <label class="text-[10px] uppercase text-gray-500 font-bold">Seed</label>
                                <div class="flex gap-2">
                                    <input type="number" id="seedInput" placeholder="Random (-1)" class="flex-1 bg-leo-input border border-leo-border rounded-lg text-white text-xs py-2 px-3 font-mono focus:border-purple-500 focus:outline-none">
                                    <button id="seedLockBtn" onclick="toggleSeedLock()" class="px-3 rounded-lg border border-leo-border bg-leo-input text-gray-400 hover:text-purple-400 transition-colors" title="Lock Seed">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"></path></svg>
                                    </button>
                                    <button onclick="randomSeed()" class="px-3 rounded-lg border border-leo-border bg-leo-input text-gray-400 hover:text-white transition-colors" title="Randomize">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                                    </button>
                                </div>
                            </div>

                            <!-- NSFW Safety Filter -->
                            <div class="pt-4 border-t border-white/10">
                                <label class="text-xs font-semibold text-leo-textMuted uppercase tracking-wider flex items-center gap-2 mb-3">
                                    <svg class="w-3.5 h-3.5 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    Safety Filters
                                </label>
                                <div class="flex items-center gap-2 bg-leo-input rounded-lg p-2.5 border border-green-500/30">
                                    <svg class="w-4 h-4 text-green-400" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"></path></svg>
                                    <span class="text-xs font-medium text-white">NSFW Filter</span>
                                    <span class="text-[9px] bg-green-500/20 text-green-300 px-2 py-0.5 rounded">ALWAYS ACTIVE</span>
                                </div>
                            </div>
                        </div>
                    </details>

                </div>
            </div>

            <!-- Footer / Generate Button -->
            <div class="p-5 border-t border-leo-border bg-leo-panel z-30">
                <button id="generateBtn" onclick="generateImage()" class="btn-generate w-full py-3.5 rounded-xl font-bold text-sm tracking-wide text-white flex items-center justify-center gap-2 group relative overflow-hidden shadow-lg shadow-purple-900/50">
                    <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300 pointer-events-none"></div>
                    <span>GENERATE</span>
                </button>
            </div>
        </aside>

        <!-- === MAIN CONTENT === -->
        <main class="flex-1 flex flex-col min-w-0 bg-[#0b0f19] relative">
            
            <!-- Top Status Bar -->
            <header class="h-14 border-b border-leo-border bg-leo-panel/50 backdrop-blur flex items-center justify-between px-6 shrink-0 z-10">
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-leo-input border border-leo-border">
                        <span id="gpuStatusDot" class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]"></span>
                        <span id="gpuStatusText" class="text-[10px] font-bold text-gray-400 uppercase tracking-wide">Ready</span>
                    </div>
                </div>
                
                <div class="flex items-center gap-4">
                     <span id="imageInfo" class="text-xs text-leo-textMuted font-mono hidden md:block opacity-50"></span>
                    <div class="text-right">
                        <div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">Generated</div>
                        <div class="text-xs font-mono text-white"><span id="imageCount">0</span> Images</div>
                    </div>
                </div>
            </header>

            <!-- Canvas Area -->
            <div class="flex-1 relative flex flex-col overflow-hidden">
                <!-- Image Wrapper -->
                <div id="previewArea" class="flex-1 checkerboard-bg relative flex items-center justify-center p-8 overflow-hidden">
                    
                    <!-- Placeholder State -->
                    <div id="placeholderText" class="text-center select-none pointer-events-none w-full h-full flex flex-col items-center justify-center relative">
                        <!-- Animated Grid Background -->
                        <div class="absolute inset-0 opacity-30">
                            <svg class="w-full h-full" xmlns="http://www.w3.org/2000/svg">
                                <defs>
                                    <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                                        <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#8b5cf6" stroke-width="0.5" opacity="0.5"/>
                                    </pattern>
                                    <linearGradient id="gridGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#d946ef;stop-opacity:0.3"/>
                                        <stop offset="50%" style="stop-color:#8b5cf6;stop-opacity:0.1"/>
                                        <stop offset="100%" style="stop-color:#06b6d4;stop-opacity:0.3"/>
                                    </linearGradient>
                                </defs>
                                <rect width="100%" height="100%" fill="url(#grid)"/>
                                <rect width="100%" height="100%" fill="url(#gridGradient)"/>
                            </svg>
                        </div>

                        <!-- Content -->
                        <div class="relative z-10 flex flex-col items-center gap-8">
                            <!-- Animated Icon -->
                            <div class="relative">
                                <div class="w-40 h-40 rounded-2xl bg-gradient-to-br from-purple-500/20 to-cyan-500/20 border border-purple-500/30 flex items-center justify-center group hover:border-purple-500/60 transition-all duration-300 shadow-lg shadow-purple-900/20">
                                    <!-- Animated Rings -->
                                    <div class="absolute inset-0 rounded-2xl border border-purple-500/20 group-hover:border-purple-500/40 transition-all" style="animation: pulse 3s ease-in-out infinite;"></div>
                                    <div class="absolute inset-2 rounded-xl border border-cyan-500/20 group-hover:border-cyan-500/40 transition-all" style="animation: pulse 4s ease-in-out infinite 0.5s;"></div>
                                    
                                    <!-- Main Icon -->
                                    <div class="relative z-10">
                                        <svg class="w-16 h-16 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>

                            <!-- Text Content -->
                            <div class="space-y-3">
                                <h3 class="text-2xl font-light text-white tracking-wide">Dream something new</h3>
                                <p class="text-sm text-gray-500">Enter a prompt and click Generate to create</p>
                                <div class="flex justify-center gap-2">
                                    <span class="px-3 py-1 rounded-full text-xs bg-purple-500/20 border border-purple-500/30 text-purple-300">AI Powered</span>
                                    <span class="px-3 py-1 rounded-full text-xs bg-cyan-500/20 border border-cyan-500/30 text-cyan-300">High Quality</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- The Image -->
                    <img id="previewImage" class="hidden relative z-10 max-h-full max-w-full object-contain shadow-2xl rounded-lg transition-all duration-500" style="box-shadow: 0 0 100px -20px rgba(0,0,0,0.8);" />
                    
                    <!-- Generation Timer Overlay -->
                    <div id="progressContainer" class="hidden absolute inset-0 bg-black/80 backdrop-blur-sm z-30 flex flex-col items-center justify-center">
                        <div class="flex flex-col items-center gap-6">
                            <!-- Timer Circle -->
                            <div class="relative w-40 h-40">
                                <!-- SVG Circle -->
                                <svg class="w-full h-full transform -rotate-90" style="filter: drop-shadow(0 0 20px rgba(139, 92, 246, 0.3));">
                                    <!-- Background Circle -->
                                    <circle cx="80" cy="80" r="70" fill="none" stroke="#30363d" stroke-width="2"/>
                                    <!-- Progress Circle -->
                                    <circle id="timerCircle" cx="80" cy="80" r="70" fill="none" stroke="url(#timerGradient)" stroke-width="3" stroke-linecap="round" stroke-dasharray="440" stroke-dashoffset="440" style="transition: stroke-dashoffset 0.3s ease;"/>
                                    <!-- Gradient Definition -->
                                    <defs>
                                        <linearGradient id="timerGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                            <stop offset="0%" style="stop-color:#d946ef;stop-opacity:1" />
                                            <stop offset="100%" style="stop-color:#8b5cf6;stop-opacity:1" />
                                        </linearGradient>
                                    </defs>
                                </svg>
                                
                                <!-- Text Center -->
                                <div class="absolute inset-0 flex flex-col items-center justify-center">
                                    <div id="timerDisplay" class="text-5xl font-bold text-white tabular-nums font-mono">0.0s</div>
                                    <div id="timerLabel" class="text-xs text-gray-400 font-mono mt-1">GENERATING</div>
                                </div>
                            </div>
                            
                            <!-- Status Info -->
                            <div class="text-center">
                                <div id="generationStatus" class="text-sm text-gray-300 mb-2">Creating your masterpiece...</div>
                                <div class="flex items-center gap-2 justify-center">
                                    <span class="w-2 h-2 bg-purple-500 rounded-full animate-pulse"></span>
                                    <span id="stepInfo" class="text-xs text-gray-500 font-mono">Processing...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Floating Action Bar -->
                <div id="imageActions" class="hidden absolute bottom-8 left-1/2 -translate-x-1/2 bg-leo-panel/90 backdrop-blur-md border border-leo-border p-1.5 rounded-2xl shadow-2xl flex items-center gap-1 z-20">
                    <button onclick="downloadImage()" class="px-4 py-2 rounded-xl text-xs font-medium text-gray-300 hover:bg-white/10 hover:text-white transition flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        Download
                    </button>
                    
                    <div class="w-px h-6 bg-white/10 mx-1"></div>

                    <!-- Upscale -->
                    <div class="relative group/upscale">
                        <button id="upscaleBtn" onclick="showUpscaleOptions()" class="px-4 py-2 rounded-xl text-xs font-medium text-purple-400 hover:bg-purple-500/10 transition flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                            Upscale
                        </button>
                        <div id="upscaleOptions" class="hidden absolute bottom-full left-1/2 -translate-x-1/2 mb-3 bg-leo-panel border border-leo-border p-1.5 rounded-xl shadow-xl flex gap-1 min-w-[180px]">
                            <button class="upscale-btn active flex-1 py-1.5 rounded-lg text-xs font-medium bg-purple-500/20 text-purple-400" onclick="selectUpscaleScale(2, this)">2x</button>
                            <button class="upscale-btn flex-1 py-1.5 rounded-lg text-xs font-medium text-gray-400 hover:bg-white/5" onclick="selectUpscaleScale(4, this)">4x</button>
                            <button class="bg-purple-600 hover:bg-purple-500 text-white px-3 py-1.5 rounded-lg text-xs font-medium transition" onclick="upscaleImage()">Go</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Galleries Bottom Panel -->
            <div class="h-[200px] bg-leo-panel border-t border-leo-border flex flex-col shrink-0">
                <div class="flex border-b border-leo-border px-4">
                    <button onclick="switchTab('recent')" class="tab-btn active px-4 py-3 text-xs font-bold uppercase tracking-wider text-gray-500 border-b-2 border-transparent hover:text-gray-300 transition" id="tab-recent">Session</button>
                    <button onclick="switchTab('output')" class="tab-btn px-4 py-3 text-xs font-bold uppercase tracking-wider text-gray-500 border-b-2 border-transparent hover:text-gray-300 transition" id="tab-output">Library</button>
                    <button onclick="switchTab('history')" class="tab-btn px-4 py-3 text-xs font-bold uppercase tracking-wider text-gray-500 border-b-2 border-transparent hover:text-gray-300 transition" id="tab-history">Prompts</button>
                    
                    <div class="flex-1 flex justify-end items-center">
                        <button onclick="refreshOutputGallery()" class="text-gray-500 hover:text-white p-2 transition">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        </button>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto p-4 custom-scrollbar bg-[#0d1117]">
                    
                    <!-- Recent -->
                    <div id="content-recent" class="tab-content active h-full">
                        <div id="gallery" class="grid grid-cols-6 lg:grid-cols-8 xl:grid-cols-10 gap-3">
                            <!-- Items inserted by JS -->
                        </div>
                    </div>

                    <!-- Output -->
                    <div id="content-output" class="tab-content h-full">
                        <div id="outputGallery" class="grid grid-cols-6 lg:grid-cols-8 xl:grid-cols-10 gap-3">
                            <div class="col-span-full text-center py-10 text-gray-600 text-xs">Loading library...</div>
                        </div>
                    </div>

                    <!-- History -->
                    <div id="content-history" class="tab-content h-full">
                        <div class="flex justify-end mb-2">
                             <button onclick="clearPromptHistory()" class="text-[10px] text-red-400 hover:text-red-300 underline">Clear History</button>
                        </div>
                        <div id="promptHistory" class="space-y-2">
                            <div class="text-center py-10 text-gray-600 text-xs">No history available</div>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <!-- 
      === ORIGINAL LOGIC WITH VISUAL HANDLERS === 
    -->
    <script>
        // Tab Switching Logic
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.classList.remove('active', 'text-white', 'border-purple-500');
                b.classList.add('text-gray-500');
            });
            document.querySelectorAll('.tab-content').forEach(c => {
                c.classList.remove('active', 'active-block');
            });
            
            const btn = document.getElementById(`tab-${tabName}`);
            btn.classList.add('active', 'text-white', 'border-purple-500');
            btn.classList.remove('text-gray-500');
            
            const content = document.getElementById(`content-${tabName}`);
            if(tabName === 'history') {
                content.classList.add('active-block');
            } else {
                content.classList.add('active');
            }
        }

        const host = window.location.hostname;
        const port = window.location.port || (window.location.protocol === 'https:' ? '443' : '80');
        const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
        
        const API_URL = `http://${host}:${port}/api`;
        const WS_URL = `${protocol}://${host}:${port}/ws/generate`;
        
        const DEFAULT_NEGATIVE_PROMPT = "lowres, bad anatomy, bad hands, text, error, missing fingers, extra digit, fewer digits, cropped, worst quality, low quality, normal quality, jpeg artifacts, signature, watermark, username, blurry, out of focus, duplicate, ugly, morbid, mutilated, mutated hands, poorly drawn face, mutation, deformed, dehydrated, bad proportions, gross proportions, malformed limbs, long neck";

        let currentStyle = 'anime_kawai'; 
        let generating = false;
        let imageCounter = 0;
        let lastPrompt = '';
        let currentImageData = null;
        let ws = null;
        let seedLocked = false;
        let promptHistory = [];
        let generationNotification = null;
        let generationActive = false;
        let selectedUpscaleScale = 2;
        
        // Timer Variables
        let timerInterval = null;
        let generationStartTime = null;
        let estimatedTotalTime = null;

        /* --- MODEL DATA FOR CUSTOM DROPDOWN --- */
        const models = [
            { id: 'anime_kawai', name: 'Anime Kawaii Diffusion', image: '/assets/thumbnails/thumbnail-anime-kawaii-diffusion.webp' },
            { id: 'stable_diffusion_2_1', name: 'Stable Diffusion 2.1', image: '/assets/thumbnails/thumbnail-sd-2.1.webp' },
            { id: 'stable_diffusion_3_5', name: 'SD 3.5 Medium', image: '/assets/thumbnails/thumbnail-sd-3.5-medium.webp' },
            { id: 'flux_1_fast', name: 'Flux.1 Fast', image: '/assets/thumbnails/thumbnail-flux-fast.webp' },
            { id: 'openjourney', name: 'Openjourney', image: '/assets/thumbnails/thumbnail-openjourney.webp' },
            { id: 'pixel_art', name: 'Pixel Art Diffusion', image: '/assets/thumbnails/thumbnail-pixel-art-diffusion.webp' },
            { id: 'pony_diffusion', name: 'Pony Diffusion v6 XL', image: '/assets/thumbnails/thumbnail-pony-diffusion-v6-xl.webp' },
            { id: 'anything_v5', name: 'Anything v5', image: '/assets/thumbnails/thumbnail-anything-v5.webp' },
            { id: 'animagine_xl', name: 'Animagine XL 3.1', image: '/assets/thumbnails/thumbnail-animagine-xl-3.1.webp' },
            { id: 'aom3', name: 'AOM3', image: null },
            { id: 'counterfeit_v3', name: 'Counterfeit v3.0', image: '/assets/thumbnails/thumbnail-counterfeit-v3.0.webp' },
        ];

        /* --- CUSTOM DROPDOWN LOGIC --- */
        function initCustomDropdown() {
            const list = document.getElementById('modelDropdownList');
            list.innerHTML = '';

            models.forEach(model => {
                const item = document.createElement('div');
                item.className = 'p-2 hover:bg-white/10 cursor-pointer flex items-center gap-3 transition-colors border-b border-white/5 last:border-0 group';
                item.onclick = () => selectModel(model.id);

                let imgHTML = '';
                if (model.image) {
                    imgHTML = `<img src="${model.image}" class="w-10 h-10 rounded object-cover bg-gray-800 shadow-sm group-hover:shadow-md transition-shadow" alt="${model.name}" onerror="this.style.display='none'">`;
                } else {
                    // Fallback visual
                    const initials = model.name.substring(0,2).toUpperCase();
                    imgHTML = `<div class="w-10 h-10 rounded bg-gray-800 flex items-center justify-center text-xs text-gray-500 font-mono border border-gray-700">${initials}</div>`;
                }

                item.innerHTML = `
                    ${imgHTML}
                    <span class="text-sm text-gray-200 group-hover:text-white transition-colors">${model.name}</span>
                `;
                list.appendChild(item);
            });

            // Close on click outside
            document.addEventListener('click', (e) => {
                const container = document.getElementById('customModelDropdown');
                if (!container.contains(e.target)) {
                    document.getElementById('modelDropdownList').classList.add('hidden');
                    document.getElementById('dropdownArrow').classList.remove('rotate-180');
                }
            });
        }

        function toggleModelDropdown() {
            const list = document.getElementById('modelDropdownList');
            const arrow = document.getElementById('dropdownArrow');
            list.classList.toggle('hidden');
            arrow.classList.toggle('rotate-180');
        }

        function selectModel(id) {
            currentStyle = id;
            document.getElementById('styleSelect').value = id; // Sync with hidden input
            
            // Update UI
            const model = models.find(m => m.id === id);
            if (model) {
                document.getElementById('selectedModelName').textContent = model.name;
                const imgPreview = document.getElementById('selectedModelPreview');
                
                if (model.image) {
                    imgPreview.style.backgroundImage = `url('${model.image}')`;
                    imgPreview.classList.remove('hidden');
                    // Simple check if image fails to load via JS background not easily doable, 
                    // but we assume assets exist as requested.
                } else {
                    imgPreview.classList.add('hidden');
                }
            }

            // Apply Presets based on selection
            const currentPreset = document.getElementById('qualityPreset').value;
            applyQualityPreset(currentPreset);
            saveSettings();
            
            // Close dropdown
            document.getElementById('modelDropdownList').classList.add('hidden');
            document.getElementById('dropdownArrow').classList.remove('rotate-180');
        }

        /* --- VISUAL RESOLUTION HANDLER --- */
        function setVisualResolution(resValue, btnElement) {
            // Update hidden select
            const select = document.getElementById('resSelect');
            select.value = resValue;
            
            // Visual feedback
            document.querySelectorAll('.aspect-btn').forEach(b => {
                b.classList.remove('active');
            });
            if(btnElement) btnElement.classList.add('active');
            
            // Trigger logic
            handleResolutionChange();
        }

        function toggleCustomRes() {
            const select = document.getElementById('resSelect');
            select.value = 'custom';
            
            document.querySelectorAll('.aspect-btn').forEach(b => {
                b.classList.remove('active');
            });
            document.getElementById('customResBtn').classList.add('active');
            
            handleResolutionChange();
        }

        function showUpscaleOptions() {
            const options = document.getElementById('upscaleOptions');
            options.classList.toggle('hidden');
        }
        
        function selectUpscaleScale(scale, btn) {
            selectedUpscaleScale = scale;
            document.querySelectorAll('.upscale-btn').forEach(b => {
                b.classList.remove('active', 'bg-purple-500/20', 'text-purple-400');
                b.classList.add('text-gray-400');
            });
            btn.classList.add('active', 'bg-purple-500/20', 'text-purple-400');
            btn.classList.remove('text-gray-400');
        }

        function loadPromptHistory() {
            try {
                const saved = localStorage.getItem('iris_prompt_history');
                if (saved) {
                    promptHistory = JSON.parse(saved);
                    updatePromptHistoryUI();
                }
            } catch (error) {
                console.error('Error loading Prompt History:', error);
            }
        }

        function saveToPromptHistory(prompt, negativePrompt, seed, width, height, steps, cfg) {
            const entry = {
                prompt: prompt,
                negativePrompt: negativePrompt,
                seed: seed,
                resolution: `${width}x${height}`,
                steps: steps,
                cfg: cfg,
                timestamp: new Date().toISOString()
            };
            
            promptHistory.unshift(entry);
            
            if (promptHistory.length > 50) {
                promptHistory = promptHistory.slice(0, 50);
            }
            
            localStorage.setItem('iris_prompt_history', JSON.stringify(promptHistory));
            updatePromptHistoryUI();
        }

        function updatePromptHistoryUI() {
            const container = document.getElementById('promptHistory');
            
            if (promptHistory.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500 text-xs">No history available</div>';
                return;
            }
            
            container.innerHTML = '';
            
            promptHistory.forEach((entry, index) => {
                const item = document.createElement('div');
                item.className = 'p-3 bg-leo-input border border-leo-border rounded-lg cursor-pointer hover:border-purple-500/50 hover:bg-[#1f2937] transition-all flex justify-between items-center group';
                item.onclick = () => loadFromHistory(index);
                
                const date = new Date(entry.timestamp);
                const timeStr = date.toLocaleString('de-DE', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                item.innerHTML = `
                    <div class="flex-1 min-w-0 mr-4">
                        <div class="text-xs font-medium text-gray-300 truncate group-hover:text-purple-400 transition-colors">${entry.prompt}</div>
                        <div class="flex gap-3 text-[10px] text-gray-500 mt-1 font-mono">
                            <span>${timeStr}</span>
                            <span>${entry.resolution}</span>
                            <span>S:${entry.seed}</span>
                        </div>
                    </div>
                    <div class="text-purple-500 opacity-0 group-hover:opacity-100 transition-opacity">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                    </div>
                `;
                
                container.appendChild(item);
            });
        }

        function loadFromHistory(index) {
            const entry = promptHistory[index];
            
            document.getElementById('promptInput').value = entry.prompt;
            document.getElementById('negativePromptInput').value = entry.negativePrompt;
            document.getElementById('seedInput').value = entry.seed;
            
            // Visual Update for Resolution
            const select = document.getElementById('resSelect');
            select.value = entry.resolution;
            // Try to find matching visual button, else custom
            let foundBtn = false;
            document.querySelectorAll('.aspect-btn').forEach(btn => {
                if(btn.onclick.toString().includes(entry.resolution)) {
                    btn.click();
                    foundBtn = true;
                } else {
                    btn.classList.remove('active');
                }
            });
            if(!foundBtn) document.getElementById('customResBtn').click();

            document.getElementById('stepsSlider').value = entry.steps;
            document.getElementById('stepsValue').textContent = entry.steps;
            document.getElementById('cfgSlider').value = entry.cfg;
            document.getElementById('cfgValue').textContent = entry.cfg;
            
            handleResolutionChange(); 

            // Visual feedback
            const promptInput = document.getElementById('promptInput').parentElement;
            promptInput.classList.add('ring-2', 'ring-purple-500');
            setTimeout(() => promptInput.classList.remove('ring-2', 'ring-purple-500'), 500);
        }

        function clearPromptHistory() {
            if (confirm('Verlauf wirklich lÃ¶schen?')) {
                promptHistory = [];
                localStorage.removeItem('iris_prompt_history');
                updatePromptHistoryUI();
            }
        }

        function showGenerationNotification(progress, step, total) {
            if (document.hidden && 'Notification' in window) {
                if (Notification.permission === 'granted') {
                    if (!generationNotification) {
                        generationNotification = new Notification('I.R.I.S. Generation', {
                            body: `Progress: ${progress}% (${step}/${total})`,
                            icon: '/static/assets/favicon.png',
                            tag: 'generation',
                            requireInteraction: false
                        });
                    } else {
                        generationNotification.close();
                        generationNotification = new Notification('I.R.I.S. Generation', {
                            body: `Progress: ${progress}% (${step}/${total})`,
                            icon: '/static/assets/favicon.png',
                            tag: 'generation',
                            requireInteraction: false
                        });
                    }
                } else if (Notification.permission !== 'denied') {
                    Notification.requestPermission();
                }
            }
            
            if (document.hidden) {
                document.title = `[${progress}%] I.R.I.S. Generating...`;
            }
        }

        function showCompletedNotification(imageSrc) {
            if (document.hidden && 'Notification' in window && Notification.permission === 'granted') {
                if (generationNotification) {
                    generationNotification.close();
                }
                
                const notification = new Notification('Generation Complete!', {
                    body: 'Click here to view your image',
                    icon: '/static/assets/favicon.png',
                    tag: 'completed',
                    requireInteraction: true,
                    image: imageSrc
                });
                
                notification.onclick = () => {
                    window.focus();
                    notification.close();
                };
            }
            
            document.title = 'I.R.I.S. Generator';
            generationNotification = null;
        }

        function loadSavedSettings() {
            try {
                const saved = localStorage.getItem('iris_settings');
                if (saved) {
                    const settings = JSON.parse(saved);
                    if (settings.style) {
                        // Use new selection logic
                        selectModel(settings.style);
                    } else {
                        // Default
                        selectModel('anime_kawai');
                    }
                    if (settings.quality) {
                        document.getElementById('qualityPreset').value = settings.quality;
                        // DO NOT applyQualityPreset here yet, handled by selectModel or wait
                    }
                    if (settings.resolution) {
                        document.getElementById('resSelect').value = settings.resolution;
                        // Trigger visual update
                        setVisualResolution(settings.resolution, null); 
                        // Find and active button manually if setVisual didn't have element passed
                         document.querySelectorAll('.aspect-btn').forEach(btn => {
                            if(btn.onclick.toString().includes(settings.resolution)) {
                                btn.classList.add('active');
                            }
                        });
                        handleResolutionChange();
                    }
                    // Load explicit steps/cfg last, to override defaults if user manually changed them
                    if (settings.steps) {
                        document.getElementById('stepsSlider').value = settings.steps;
                        document.getElementById('stepsValue').textContent = settings.steps;
                    }
                    if (settings.cfg) {
                        document.getElementById('cfgSlider').value = settings.cfg;
                        document.getElementById('cfgValue').textContent = settings.cfg;
                    }
                    if (settings.negativePrompt) {
                        document.getElementById('negativePromptInput').value = settings.negativePrompt;
                    }
                } else {
                    // Initial load default
                    selectModel('anime_kawai');
                }
            } catch (error) {
                console.error('Failed to load settings:', error);
                selectModel('anime_kawai');
            }
            
            loadPromptHistory();
        }

        function saveSettings() {
            try {
                const settings = {
                    style: currentStyle,
                    quality: document.getElementById('qualityPreset').value,
                    resolution: document.getElementById('resSelect').value,
                    steps: parseInt(document.getElementById('stepsSlider').value),
                    cfg: parseFloat(document.getElementById('cfgSlider').value),
                    negativePrompt: document.getElementById('negativePromptInput').value
                };
                localStorage.setItem('iris_settings', JSON.stringify(settings));
            } catch (error) {
                console.error('Failed to save settings:', error);
            }
        }

        function showDetailedError(errorType, errorMessage) {
            alert(`Error: ${errorMessage}`);
        }

        // Renamed/Deprecated original setStyle in favor of selectModel, but kept logic for internal use if needed
        function setStyle(style) {
            selectModel(style);
        }

        function toggleSeedLock() {
            seedLocked = !seedLocked;
            const seedInput = document.getElementById('seedInput');
            const lockBtn = document.getElementById('seedLockBtn');
            
            if (seedLocked) {
                seedInput.readOnly = true;
                lockBtn.classList.add('text-purple-400', 'bg-purple-900/20', 'border-purple-500');
                lockBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>';
            } else {
                seedInput.readOnly = false;
                lockBtn.classList.remove('text-purple-400', 'bg-purple-900/20', 'border-purple-500');
                lockBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"></path></svg>';
            }
        }

        function randomSeed() {
            if (!seedLocked) {
            const seed = Math.floor(100000 + Math.random() * 900000);
                document.getElementById('seedInput').value = seed;
            }
        }

        function randomPrompt() {
            const prompts = [
                "masterpiece, best quality, ultra-detailed, high resolution, cinematic lighting, 1girl, anime girl with cyan hair, cat ears, fox tail, wearing white tactical jacket, black pleated skirt, futuristic city background, soft bokeh, glowing eyes, highly intricate details",
                "masterpiece, best quality, ultra-detailed, 1girl, anime girl, pastel pink hair, long hair, cat ears, holding magical staff, starry night background, glowing particles, detailed eyes, soft lighting, fantasy style",
                "masterpiece, best quality, 1girl, cyberpunk, neon blue hair, bob cut, futuristic tech armor, glowing circuit patterns, night city background, rain, neon lights, dynamic pose, sharp focus",
                "masterpiece, best quality, 1girl, elf, silver hair, long braided hair, pointed ears, green archer outfit, mystical forest background, sunlight filtering through trees, nature, ethereal atmosphere",
                "masterpiece, best quality, 1girl, chibi, cute, oversized orange hoodie, animal tail, happy expression, holding bubble tea, kawaii, simple background, soft colors",
                "masterpiece, best quality, 1girl, warrior, red hair, ponytail, holding sword, battle armor, intricate design, dramatic pose, battlefield background, fire embers, intensity, cinematic lighting",
                "masterpiece, best quality, 1girl, astronaut suit, futuristic pilot, helmet off, floating in zero gravity, spaceship interior, stars visible through window, detailed sci-fi elements",
                "masterpiece, best quality, 1girl, traditional japanese clothes, kimono, floral pattern, black hair, hime cut, cherry blossoms falling, temple background, soft sunlight, elegant, serenity",
                "masterpiece, best quality, 1girl, school uniform, sailor suit, navy blue skirt, short brown hair, smiling, classroom setting, sunset light through window, sentimental atmosphere, slice of life",
                "masterpiece, best quality, 1girl, gothic lolita, black dress, frills, lace, white hair, red eyes, holding a rose, dark castle background, moonlight, mysterious, gloomy",
                "masterpiece, best quality, 1girl, maid outfit, french maid, blonde hair, twin tails, holding a tray with tea, victorian mansion interior, elegant, detailed fabric",
                "masterpiece, best quality, 1girl, witch, purple robe, large wizard hat, flying on broom, full moon background, clouds, magical effects, wind, dynamic angle",
                "masterpiece, best quality, 1girl, casual clothes, denim shorts, white t-shirt, headphones around neck, street background, graffiti, urban style, cool vibes, lens flare",
                "masterpiece, best quality, 1girl, princess, royal gown, tiara, golden hair, curls, ballroom background, chandelier, sparkling, grandeur, fantasy",
                "masterpiece, best quality, 1girl, demon girl, horns, bat wings, black and red dress, dark magic, glowing runes, floating rocks, chaotic background, powerful",
                "masterpiece, best quality, 1girl, steampunk, brown leather jacket, goggles, gears, victorian city background, steam, brass details, adventure style"
            ];
            document.getElementById('promptInput').value = prompts[Math.floor(Math.random() * prompts.length)];
        }

        function useLastPrompt() {
            if (lastPrompt) {
                document.getElementById('promptInput').value = lastPrompt;
            }
        }

        function applyQualityPreset(preset) {
            const modelKey = currentStyle;
            
            // --- LOGIK: STANDARDWERTE (SD 1.5) ---
            let defaults = {
                fast:     { steps: 20, cfg: 7.0 },
                balanced: { steps: 30, cfg: 7.5 },
                high:     { steps: 50, cfg: 8.0 },
                extreme:  { steps: 75, cfg: 10.0 }
            };

            // --- LOGIK: MODELL-SPEZIFISCHE ÃœBERSCHREIBUNGEN ---
            const modelConfigs = {
                // Flux: Braucht sehr wenige Steps & niedrigen CFG
                'flux_1_fast': {
                    fast:     { steps: 4, cfg: 1.0 },
                    balanced: { steps: 8, cfg: 3.5 },
                    high:     { steps: 12, cfg: 4.0 },
                    extreme:  { steps: 20, cfg: 4.5 }
                },
                // SDXL Models (Pony, Animagine): Brauchen ca 30 Steps, CFG 5-7
                'pony_diffusion': {
                    fast:     { steps: 20, cfg: 5.0 },
                    balanced: { steps: 30, cfg: 7.0 },
                    high:     { steps: 50, cfg: 8.0 },
                    extreme:  { steps: 70, cfg: 9.0 }
                },
                'animagine_xl': {
                    fast:     { steps: 20, cfg: 5.0 },
                    balanced: { steps: 30, cfg: 7.0 },
                    high:     { steps: 50, cfg: 8.0 },
                    extreme:  { steps: 70, cfg: 9.0 }
                },
                // SD 3.5: Moderater CFG
                'stable_diffusion_3_5': {
                    fast:     { steps: 20, cfg: 4.5 },
                    balanced: { steps: 35, cfg: 6.5 },
                    high:     { steps: 50, cfg: 7.5 },
                    extreme:  { steps: 70, cfg: 8.5 }
                },
                // SD 2.1: Mag oft hÃ¶here CFG Werte
                'stable_diffusion_2_1': {
                    fast:     { steps: 25, cfg: 7.0 },
                    balanced: { steps: 40, cfg: 9.0 },
                    high:     { steps: 60, cfg: 10.0 },
                    extreme:  { steps: 80, cfg: 12.0 }
                },
                // Anything V5 (SD 1.5 Anime): Standard, aber oft etwas weniger Steps OK
                'anything_v5': {
                    fast:     { steps: 20, cfg: 6.0 },
                    balanced: { steps: 28, cfg: 7.0 },
                    high:     { steps: 45, cfg: 8.0 },
                    extreme:  { steps: 60, cfg: 9.0 }
                }
            };

            // WÃ¤hle Konfiguration: Spezifisch oder Standard
            const config = modelConfigs[modelKey] ? modelConfigs[modelKey][preset] : defaults[preset];

            // Werte anwenden
            if (config) {
                const stepsSlider = document.getElementById('stepsSlider');
                const cfgSlider = document.getElementById('cfgSlider');
                
                stepsSlider.value = config.steps;
                document.getElementById('stepsValue').textContent = config.steps;
                
                cfgSlider.value = config.cfg;
                document.getElementById('cfgValue').textContent = config.cfg.toFixed(1);
                
                saveSettings();
            }
        }


        function handleResolutionChange() {
            const resSelect = document.getElementById('resSelect');
            const customResContainer = document.getElementById('customResContainer');
            
            if (resSelect.value === 'custom') {
                customResContainer.classList.remove('hidden');
            } else {
                customResContainer.classList.add('hidden');
            }
        }

        function updateProgress(data) {
            if (generationActive && generationStartTime) {
                const elapsed = (Date.now() - generationStartTime) / 1000;
                const progress = data.progress || 0;
                const step = data.step || 0;
                const totalSteps = data.total_steps || 0;
                
                // Update Timer Display
                document.getElementById('timerDisplay').textContent = elapsed.toFixed(1) + 's';
                document.getElementById('stepInfo').textContent = `Step ${step}/${totalSteps}`;
                
                // Update Circular Progress
                if (totalSteps > 0) {
                    const circumference = 440; // 2 * Ï€ * 70
                    const offset = circumference * (1 - progress / 100);
                    document.getElementById('timerCircle').style.strokeDashoffset = offset;
                }
                
                // Update Label based on progress
                if (progress < 30) {
                    document.getElementById('timerLabel').textContent = 'WARMING UP';
                } else if (progress < 70) {
                    document.getElementById('timerLabel').textContent = 'REFINING';
                } else {
                    document.getElementById('timerLabel').textContent = 'FINISHING';
                }
                
                showGenerationNotification(Math.floor(progress), step, totalSteps);
            }
        }

        function handleCompletion(data) {
            // Stop timer
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            // Show final time
            const finalTime = data.generation_time || (Date.now() - generationStartTime) / 1000;
            document.getElementById('timerDisplay').textContent = finalTime.toFixed(1) + 's';
            document.getElementById('timerLabel').textContent = 'COMPLETE';
            document.getElementById('generationStatus').textContent = 'âœ¨ Masterpiece created!';
            document.getElementById('stepInfo').textContent = `Generated in ${finalTime.toFixed(2)} seconds`;
            
            // Complete circle animation
            document.getElementById('timerCircle').style.strokeDashoffset = 0;
            
            lastPrompt = document.getElementById('promptInput').value;
            const steps = parseInt(document.getElementById('stepsSlider').value);
            const cfg = parseFloat(document.getElementById('cfgSlider').value);
            const negativePrompt = document.getElementById('negativePromptInput').value;
            
            const resSelect = document.getElementById('resSelect');
            let width, height;
            if (resSelect.value === 'custom') {
                width = parseInt(document.getElementById('customWidth').value);
                height = parseInt(document.getElementById('customHeight').value);
            } else {
                [width, height] = resSelect.value.split('x').map(Number);
            }
            
            saveToPromptHistory(lastPrompt, negativePrompt, data.seed, width, height, steps, cfg);
            
            showCompletedNotification(data.image);
            
            finishGeneration(data);
            if (ws) {
                ws.close();
                ws = null;
            }
            generationActive = false;
        }

        function handleError(data) {
            showDetailedError('error', data.message || 'Unknown error');
            resetUI();
            if (ws) {
                ws.close();
                ws = null;
            }
            generationActive = false;
        }

        async function generateImage() {
            if (generating) return;
            
            if (ws && ws.readyState !== WebSocket.CLOSED) {
                ws.close();
                ws = null;
            }
            
            let width, height;
            const resSelect = document.getElementById('resSelect');
            if (resSelect.value === 'custom') {
                width = parseInt(document.getElementById('customWidth').value);
                height = parseInt(document.getElementById('customHeight').value);
                if (!width || !height) return alert('Invalid dimensions');
            } else {
                [width, height] = resSelect.value.split('x').map(Number);
            }
            
            const megapixels = (width * height) / 1000000;
            if (megapixels > 2 && !confirm('High resolution may take time. Continue?')) return;
            
            saveSettings();
            
            generating = true;
            generationActive = true;
            const btn = document.getElementById('generateBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="animate-spin">â†»</span> PROCESSING';
            
            document.getElementById('gpuStatusDot').classList.remove('bg-green-500');
            document.getElementById('gpuStatusDot').classList.add('bg-purple-500', 'animate-pulse');
            document.getElementById('gpuStatusText').textContent = 'Generating...';
            
            document.getElementById('placeholderText').classList.add('hidden');
            document.getElementById('previewImage').classList.add('opacity-50');
            document.getElementById('progressContainer').classList.remove('hidden');
            
            // Initialize Timer
            generationStartTime = Date.now();
            document.getElementById('timerDisplay').textContent = '0.0s';
            document.getElementById('timerLabel').textContent = 'INITIALIZING';
            document.getElementById('generationStatus').textContent = 'Creating your masterpiece...';
            document.getElementById('stepInfo').textContent = 'Processing...';
            document.getElementById('timerCircle').style.strokeDashoffset = 440;
            
            // Update timer every 100ms
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (generationActive && generationStartTime) {
                    const elapsed = (Date.now() - generationStartTime) / 1000;
                    document.getElementById('timerDisplay').textContent = elapsed.toFixed(1) + 's';
                }
            }, 100);
            
            const prompt = document.getElementById('promptInput').value;
            lastPrompt = prompt;
            
            let seed = null;
            if (seedLocked) {
                const seedInput = document.getElementById('seedInput').value;
                seed = seedInput ? parseInt(seedInput) : Math.floor(Math.random() * 100000);
            } else {
                seed = document.getElementById('seedInput').value ? parseInt(document.getElementById('seedInput').value) : null;
            }
            
            const settings = {
                prompt: prompt,
                negative_prompt: document.getElementById('negativePromptInput').value,
                style: currentStyle,
                seed: seed,
                steps: parseInt(document.getElementById('stepsSlider').value),
                cfg_scale: parseFloat(document.getElementById('cfgSlider').value),
                width: width,
                height: height,
                nsfw_filter_enabled: true
            };
            
            try {
                ws = new WebSocket(WS_URL);
                
                ws.onopen = () => ws.send(JSON.stringify(settings));
                
                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    if (data.type === 'progress') updateProgress(data);
                    else if (data.type === 'completed') handleCompletion(data);
                    else if (data.type === 'warning') {
                        // Handle NSFW warning
                        if (data.nsfw_blocked) {
                            alert('ðŸ›¡ï¸ Safety Filter Active\n\n' + data.message);
                            resetUI();
                        } else {
                            console.warn('Warning:', data.message);
                        }
                    }
                    else if (data.type === 'error') handleError(data);
                };
                
                ws.onerror = (error) => {
                    alert('Connection Error');
                    resetUI();
                };
                
                ws.onclose = () => {
                    if (generating) resetUI();
                };
                
            } catch (error) {
                resetUI();
            }
        }

        function resetUI() {
            generating = false;
            generationActive = false;
            
            // Clear timer
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            generationStartTime = null;
            
            const btn = document.getElementById('generateBtn');
            btn.disabled = false;
            btn.innerHTML = '<span>GENERATE</span> <span class="bg-black/20 text-xs px-2 py-0.5 rounded text-white/80 font-mono ml-2">1 TKN</span>';
            
            document.getElementById('gpuStatusDot').classList.remove('bg-purple-500', 'animate-pulse');
            document.getElementById('gpuStatusDot').classList.add('bg-green-500');
            document.getElementById('gpuStatusText').textContent = 'System Ready';
            
            document.getElementById('progressContainer').classList.add('hidden');
            document.getElementById('previewImage').classList.remove('opacity-50');
        }

        function finishGeneration(data) {
            currentImageData = data;
            
            const img = document.getElementById('previewImage');
            img.onload = () => {
                img.classList.remove('hidden');
                img.classList.remove('opacity-50');
                document.getElementById('progressContainer').classList.add('hidden');
            };
            img.src = data.image;
            img.dataset.filename = data.filename;
            
            document.getElementById('imageActions').classList.remove('hidden');
            
            imageCounter++;
            document.getElementById('imageCount').textContent = imageCounter;
            document.getElementById('imageInfo').textContent = `Seed: ${data.seed} | ${(data.generation_time).toFixed(1)}s | ${data.width}x${data.height}`;
            
            if (data.seed && !seedLocked) {
                document.getElementById('seedInput').value = data.seed;
            }
            
            resetUI();
            addToGallery(data.image, data.filename, lastPrompt, data.seed);
            refreshOutputGallery();
        }

        function addToGallery(imageSrc, filename, prompt, seed) {
            const gallery = document.getElementById('gallery');
            const container = document.createElement('div');
            container.className = 'aspect-square rounded-lg overflow-hidden border border-leo-border cursor-pointer hover:border-purple-500 transition relative group bg-leo-input';
            container.onclick = () => showImage(imageSrc, filename, prompt, seed);
            
            container.innerHTML = `
                <img src="${imageSrc}" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                </div>
            `;
            
            gallery.prepend(container);
            if(gallery.children.length > 20) gallery.removeChild(gallery.lastChild);
        }

        function showImage(src, filename, prompt, seed) {
            const img = document.getElementById('previewImage');
            img.src = src;
            img.dataset.filename = filename;
            img.classList.remove('hidden');
            document.getElementById('placeholderText').classList.add('hidden');
            document.getElementById('imageActions').classList.remove('hidden');
            document.getElementById('imageInfo').textContent = `Seed: ${seed} (Viewing History)`;
            currentImageData = { image: src, filename: filename, seed: seed };
        }

        function downloadImage() {
            const img = document.getElementById('previewImage');
            const link = document.createElement('a');
            link.href = img.src;
            link.download = img.dataset.filename || 'generated_image.png';
            link.click();
        }

        async function upscaleImage() {
            if (!currentImageData) return alert('No image selected');
            
            const btn = document.getElementById('upscaleBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="animate-spin">â†»</span> Upscaling...';
            
            try {
                const response = await fetch(API_URL + '/upscale', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filename: currentImageData.filename,
                        scale: selectedUpscaleScale
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    document.getElementById('previewImage').src = data.image;
                    currentImageData.filename = data.filename;
                    alert('Upscale successful!');
                } else {
                    alert('Upscale failed: ' + data.error);
                }
            } catch (e) {
                alert('Connection failed');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
                document.getElementById('upscaleOptions').classList.add('hidden');
            }
        }
        
        async function refreshOutputGallery() {
             try {
                const response = await fetch(API_URL + '/output-gallery');
                const data = await response.json();
                const gallery = document.getElementById('outputGallery');
                
                if (data.images.length === 0) {
                    gallery.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500">No images found</div>';
                    return;
                }
                
                gallery.innerHTML = '';
                data.images.forEach(filename => {
                    const container = document.createElement('div');
                    container.className = 'aspect-square rounded-lg overflow-hidden border border-leo-border cursor-pointer hover:border-purple-500 transition relative group bg-leo-input';
                    
                    const img = document.createElement('img');
                    img.loading = 'lazy';
                    img.src = API_URL + `/output-image/${filename}`;
                    img.className = 'w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity';
                    
                    container.onclick = () => showImage(img.src, filename, 'Library Image', '?');
                    container.appendChild(img);
                    gallery.appendChild(container);
                });
            } catch (e) { console.error(e); }
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            initCustomDropdown(); // Load Dropdown
            loadSavedSettings();
            randomSeed();
            refreshOutputGallery();
            
            // Keyboard Shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey && document.activeElement.tagName !== 'TEXTAREA') {
                    if (!generating) generateImage();
                }
            });
        });
    </script>
</body>
</html>