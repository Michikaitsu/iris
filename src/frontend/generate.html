<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Updated title to I.R.I.S. -->
    <title>Generate - I.R.I.S.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fixed favicon path -->
    <link rel="icon" type="image/png" href="/static/assets/favicon.png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* Updated color scheme from purple to cyan/teal */
        :root {
            --primary: #06b6d4;
            --primary-light: #22d3ee;
            --primary-dark: #0891b2;
        }
        
        body {
            background: #0a0a0a;
            color: #e5e5e5;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .card {
            background: rgba(26, 26, 26, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            border-color: rgba(6, 182, 212, 0.3);
            box-shadow: 0 8px 32px rgba(6, 182, 212, 0.1);
        }
        
        input, select, textarea {
            width: 100%;
            background: rgba(20, 20, 20, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 0.75rem;
            font-size: 14px;
            color: #e5e5e5;
            transition: all 0.3s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #06b6d4;
            background: rgba(30, 30, 30, 0.95);
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
        }
        
        input::placeholder, textarea::placeholder {
            color: #666;
        }
        
        select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L6 6L11 1' stroke='%2306b6d4' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            padding-right: 2.5rem;
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .btn {
            border: none;
            border-radius: 10px;
            padding: 0.75rem 1.5rem;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #06b6d4 0%, #14b8a6 100%);
            color: white;
            box-shadow: 0 4px 20px rgba(6, 182, 212, 0.3);
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(6, 182, 212, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            color: #e5e5e5;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(6, 182, 212, 0.3);
        }
        
        .label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #06b6d4;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .preview-area {
            background: rgba(15, 15, 15, 0.5);
            border: 2px dashed rgba(6, 182, 212, 0.3);
            border-radius: 16px;
            min-height: 500px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .preview-area img {
            max-width: 100%;
            max-height: 600px;
            object-fit: contain;
            border-radius: 8px;
        }
        
        .progress-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
            overflow: hidden;
            width: 100%;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #06b6d4 0%, #14b8a6 50%, #06b6d4 100%);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
            transition: width 0.3s ease;
        }
        
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 0.75rem;
        }
        
        .gallery-item {
            aspect-ratio: 1;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .gallery-item:hover {
            border-color: #06b6d4;
            transform: scale(1.05);
            box-shadow: 0 8px 24px rgba(6, 182, 212, 0.3);
        }
        
        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
        }
        
        .badge-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c55e;
            box-shadow: 0 0 10px #22c55e;
            animation: pulse 2s infinite;
        }
        
        .badge-dot.warning {
            background: #f59e0b;
            box-shadow: 0 0 10px #f59e0b;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.05);
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #06b6d4 0%, #14b8a6 100%);
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(6, 182, 212, 0.5);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #06b6d4 0%, #14b8a6 100%);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 10px rgba(6, 182, 212, 0.5);
        }
        
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(6, 182, 212, 0.5);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(6, 182, 212, 0.7);
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 700;
            background: linear-gradient(135deg, #06b6d4 0%, #14b8a6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
        }
        
        details summary {
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            color: #06b6d4;
            padding: 0.5rem 0;
            user-select: none;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        details[open] summary {
            margin-bottom: 1rem;
        }
        
        .warning-text {
            font-size: 12px;
            color: #f59e0b;
            margin-top: 0.5rem;
        }
        
        .generating {
            position: relative;
        }
        
        .generating::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            border: 4px solid rgba(6, 182, 212, 0.2);
            border-top-color: #06b6d4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        h1 {
            background: linear-gradient(135deg, #06b6d4 0%, #14b8a6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Picture-in-Picture Floating Window Styles */
        #pipWindow {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 320px;
            background: rgba(15, 23, 42, 0.98);
            border: 2px solid #06b6d4;
            border-radius: 12px;
            padding: 16px;
            z-index: 9999;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
        }
        
        #pipWindow.hidden {
            display: none;
        }
        
        .pip-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .pip-title {
            font-weight: 600;
            color: #06b6d4;
            font-size: 14px;
        }
        
        .pip-close {
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-size: 20px;
            line-height: 1;
            padding: 0;
            width: 24px;
            height: 24px;
        }
        
        .pip-close:hover {
            color: #ef4444;
        }
        
        .pip-progress {
            margin-bottom: 12px;
        }
        
        .pip-image {
            width: 100%;
            border-radius: 8px;
            margin-top: 12px;
        }
        
        .pip-actions {
            margin-top: 12px;
            display: flex;
            gap: 8px;
        }
        
        .pip-btn {
            flex: 1;
            padding: 8px;
            background: #06b6d4;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }
        
        .pip-btn:hover {
            background: #0891b2;
        }
        
        /* Added upscale scale selector styles */
        .upscale-options {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .upscale-btn {
            flex: 1;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #e5e5e5;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .upscale-btn:hover {
            border-color: #06b6d4;
            background: rgba(6, 182, 212, 0.1);
        }
        
        .upscale-btn.active {
            background: linear-gradient(135deg, #06b6d4 0%, #14b8a6 100%);
            border-color: #06b6d4;
            color: white;
        }
    </style>
</head>
<body class="bg-[#0a0e1a] text-white min-h-screen">
    <div class="container">
        <!-- Header -->
        <!-- Updated header with I.R.I.S. branding -->
        <header class="card mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold mb-1">I.R.I.S.</h1>
                    <p class="text-sm text-gray-500">Intelligent Rendering & Image Synthesis</p>
                </div>
                
                <div class="flex items-center gap-3">
                    <div class="badge">
                        <span id="gpuStatusDot" class="badge-dot"></span>
                        <span id="gpuStatusText">Ready</span>
                    </div>
                    <div class="badge">
                        <span id="imageCount">0</span> generated
                    </div>
                    <a href="/settings" class="btn btn-secondary">Settings</a>
                    <a href="/gallery" class="btn btn-secondary">Gallery</a>
                </div>
            </div>
        </header>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Left Sidebar -->
            <aside class="lg:col-span-1 space-y-6">
                
                <!-- Prompt -->
                <div class="card">
                    <label class="label">Prompt</label>
                    <textarea id="promptInput" rows="4" placeholder="Describe your image...">anime girl with cyan hair, cat ears, fox tail, white jacket, black skirt</textarea>
                    
                    <div class="grid grid-cols-2 gap-2 mt-3">
                        <button onclick="randomPrompt()" class="btn btn-secondary">Random</button>
                        <button onclick="useLastPrompt()" class="btn btn-secondary">Last</button>
                    </div>
                </div>
                
                <!-- Negative Prompt -->
                <div class="card">
                    <label class="label">Negative Prompt</label>
                    <textarea id="negativePromptInput" rows="2" placeholder="Things to avoid...">lowres, bad anatomy, bad hands, worst quality, blurry, nsfw</textarea>
                </div>
                
                <!-- Settings -->
                <div class="card">
                    <div class="section-title">Settings</div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="label">Style</label>
                            <select id="styleSelect" onchange="setStyle(this.value)">
                                <option value="anime">Anime</option>
                                <option value="pixel">Pixel Art</option>
                                <option value="realistic">Realistic</option>
                                <option value="abstract">Abstract / Artistic</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="label">Quality</label>
                            <select id="qualityPreset" onchange="applyQualityPreset(this.value)">
                                <option value="fast">Fast (20 steps)</option>
                                <option value="medium">Medium (28 steps)</option>
                                <option value="balanced" selected>Balanced (35 steps)</option>
                                <option value="quality">Quality (50 steps)</option>
                                <option value="high">High (75 steps)</option>
                                <option value="extreme">Extreme (100 steps)</option>
                                <option value="ultra">Ultra (150 steps)</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="label">Resolution</label>
                            <!-- Added custom resolution input option -->
                            <select id="resSelect" onchange="handleResolutionChange()">
                                <option value="256x256">256x256 (Ultra Fast)</option>
                                <option value="384x384">384x384 (Very Fast)</option>
                                <option value="512x512">512x512 (Fast)</option>
                                <option value="512x768" selected>512x768 (Portrait)</option>
                                <option value="768x512">768x512 (Landscape)</option>
                                <option value="768x768">768x768 (Square)</option>
                                <option value="1024x768">1024x768 (HD)</option>
                                <option value="768x1024">768x1024 (HD Portrait)</option>
                                <option value="1024x1024">1024x1024 (HD Square)</option>
                                <option value="720x1280">720x1280 (Mobile Wallpaper HD)</option>
                                <option value="1080x1920">1080x1920 (Mobile Wallpaper Full HD)</option>
                                <option value="1280x1280">1280x1280 (High Resolution)</option>
                                <option value="1536x1536">1536x1536 (Very High Resolution - Requires Strong GPU)</option>
                                <option value="2048x2048">2048x2048 (Ultra High Resolution - Requires Powerful GPU)</option>
                                <option value="2560x2560">2560x2560 (Extreme Resolution - Requires Very Powerful GPU)</option>
                                <option value="3072x3072">3072x3072 (4K+ - Requires Extreme GPU)</option>
                                <option value="4096x4096">4096x4096 (Maximum - Requires Top-Tier GPU with 24GB+ VRAM)</option>
                                <option value="custom">✨ Custom Resolution</option>
                            </select>
                            <!-- Custom resolution input (hidden by default) -->
                            <div id="customResContainer" style="display: none; margin-top: 10px;">
                                <div class="flex gap-2">
                                    <input type="number" id="customWidth" placeholder="Width" min="256" max="4096" class="flex-1">
                                    <span class="flex items-center">×</span>
                                    <input type="number" id="customHeight" placeholder="Height" min="256" max="4096" class="flex-1">
                                </div>
                                <p class="text-sm text-gray-400 mt-1">Example: 512 × 812 for custom aspect ratio</p>
                            </div>
                            <div id="resolutionWarning" class="text-sm text-yellow-500 mt-1" style="display: none;">
                                ⚠️ This resolution requires a powerful GPU with high VRAM!
                            </div>
                        </div>
                        
                        <div>
                            <label class="label">Seed</label>
                            <div class="flex gap-2">
                                <input type="number" id="seedInput" placeholder="Random" class="flex-1">
                                <button id="seedLockBtn" onclick="toggleSeedLock()" class="btn btn-secondary">Unlocked</button>
                                <button onclick="randomSeed()" class="btn btn-secondary">Dice</button>
                            </div>
                        </div>
                        
                        <!-- Advanced -->
                        <details>
                            <summary class="label">Advanced Options</summary>
                            <div class="space-y-4">
                                <div>
                                    <div class="flex justify-between mb-2">
                                        <label class="label mb-0">Steps</label>
                                        <span id="stepsValue" class="text-sm font-semibold">35</span>
                                    </div>
                                    <input id="stepsSlider" type="range" min="10" max="150" value="35"
                                        oninput="document.getElementById('stepsValue').textContent = this.value">
                                </div>
                                <div>
                                    <div class="flex justify-between mb-2">
                                        <label class="label mb-0">CFG Scale</label>
                                        <span id="cfgValue" class="text-sm font-semibold">10.0</span>
                                    </div>
                                    <!-- Increased CFG scale precision to 0.1 steps and expanded range -->
                                    <input id="cfgSlider" type="range" min="1" max="20" step="0.1" value="10"
                                        oninput="document.getElementById('cfgValue').textContent = parseFloat(this.value).toFixed(1)">
                                </div>
                            </div>
                        </details>
                    </div>
                </div>
                
                <!-- Generate Button -->
                <button id="generateBtn" onclick="generateImage()" class="btn btn-primary w-full">
                    Generate Image
                </button>
                
            </aside>
            
            <!-- Main Content -->
            <section class="lg:col-span-2 space-y-6">
                
                <!-- Preview -->
                <div class="card">
                    <div class="flex justify-between items-center mb-4">
                        <div class="section-title mb-0">Preview</div>
                        <div id="imageInfo" class="text-sm text-gray-500">Ready to generate</div>
                    </div>
                    
                    <div id="previewArea" class="preview-area">
                        <div id="placeholderText" class="text-center text-gray-400">
                            <div class="text-5xl mb-3">I.R.I.S.</div>
                            <p class="font-medium">Configure settings and generate</p>
                            <p class="text-sm mt-1">Your image will appear here</p>
                        </div>
                        <img id="previewImage" class="hidden" />
                    </div>
                    
                    <!-- Progress -->
                    <div id="progressContainer" class="hidden mt-4">
                        <div class="flex justify-between text-sm mb-2">
                            <span id="progressText" class="font-medium">Generating...</span>
                            <span id="progressPercent" class="font-semibold">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div id="progressBar" class="progress-fill" style="width:0%"></div>
                        </div>
                        <div id="etaText" class="text-xs text-gray-500 mt-2">Estimated time: calculating...</div>
                    </div>
                    
                    <!-- Actions -->
                    <!-- Added upscale scale options -->
                    <div id="imageActions" class="hidden mt-4">
                        <div class="grid grid-cols-4 gap-2 mb-3">
                            <button onclick="downloadImage()" class="btn btn-secondary">Download</button>
                            <button id="upscaleBtn" onclick="showUpscaleOptions()" class="btn btn-secondary">Upscale</button>
                            <button onclick="createVariation()" class="btn btn-secondary">Variation</button>
                            <button onclick="img2img()" class="btn btn-secondary">Edit</button>
                        </div>
                        <div id="upscaleOptions" class="hidden upscale-options">
                            <button class="upscale-btn active" onclick="selectUpscaleScale(2, this)">2x</button>
                            <button class="upscale-btn" onclick="selectUpscaleScale(4, this)">4x</button>
                            <button class="upscale-btn" onclick="selectUpscaleScale(8, this)">8x (Best)</button>
                            <button class="btn btn-primary" onclick="upscaleImage()">Apply</button>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Gallery -->
                <div class="card">
                    <div class="section-title">Recent Images</div>
                    <div id="gallery" class="gallery-grid"></div>
                </div>
                
                <!-- Output Gallery -->
                <div class="card">
                    <div class="flex justify-between items-center mb-4">
                        <div class="section-title mb-0">All Outputs</div>
                        <button onclick="refreshOutputGallery()" class="btn btn-secondary">Refresh</button>
                    </div>
                    <div id="outputGallery" class="gallery-grid max-h-80 overflow-y-auto">
                        <div class="col-span-full text-center py-8 text-gray-400">Loading...</div>
                    </div>
                </div>

                <!-- Prompt History -->
                <div class="card">
                    <div class="flex justify-between items-center mb-4">
                        <div class="section-title mb-0">Prompt History</div>
                        <button onclick="clearPromptHistory()" class="btn btn-secondary text-xs">Clear</button>
                    </div>
                    <div id="promptHistory" class="space-y-2 max-h-80 overflow-y-auto">
                        <div class="text-center py-8 text-gray-400 text-sm">No history available</div>
                    </div>
                </div>
                
            </section>
        </div>
    </div>

    <!-- Removed Picture-in-Picture Floating Window HTML -->

    <script>
        const host = window.location.hostname;
        const port = window.location.port || (window.location.protocol === 'https:' ? '443' : '80');
        const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
        
        const API_URL = `http://${host}:${port}/api`;
        const WS_URL = `${protocol}://${host}:${port}/ws/generate`;
        
        const DEFAULT_NEGATIVE_PROMPT = "lowres, bad anatomy, bad hands, worst quality, low quality, blurry, nsfw, nude";

        let currentStyle = 'anime';
        let generating = false;
        let imageCounter = 0;
        let lastPrompt = '';
        let currentImageData = null;
        let ws = null;
        let seedLocked = false;
        let promptHistory = [];
        let generationNotification = null;
        let pipActive = false; // Removed PIP JavaScript variables and functions
        let generationActive = false;
        let selectedUpscaleScale = 2; // Added upscale scale state

        function showUpscaleOptions() {
            const options = document.getElementById('upscaleOptions');
            options.classList.toggle('hidden');
        }
        
        function selectUpscaleScale(scale, btn) {
            selectedUpscaleScale = scale;
            document.querySelectorAll('.upscale-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function loadPromptHistory() {
            try {
                const saved = localStorage.getItem('iris_prompt_history');
                if (saved) {
                    promptHistory = JSON.parse(saved);
                    updatePromptHistoryUI();
                }
            } catch (error) {
                console.error('Error loading Prompt History:', error);
            }
        }

        function saveToPromptHistory(prompt, negativePrompt, seed, width, height, steps, cfg) {
            const entry = {
                prompt: prompt,
                negativePrompt: negativePrompt,
                seed: seed,
                resolution: `${width}x${height}`,
                steps: steps,
                cfg: cfg,
                timestamp: new Date().toISOString()
            };
            
            promptHistory.unshift(entry);
            
            if (promptHistory.length > 50) {
                promptHistory = promptHistory.slice(0, 50);
            }
            
            localStorage.setItem('iris_prompt_history', JSON.stringify(promptHistory));
            updatePromptHistoryUI();
        }

        function updatePromptHistoryUI() {
            const container = document.getElementById('promptHistory');
            
            if (promptHistory.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-400 text-sm">No history available</div>';
                return;
            }
            
            container.innerHTML = '';
            
            promptHistory.forEach((entry, index) => {
                const item = document.createElement('div');
                item.className = 'p-3 bg-[rgba(15,15,15,0.5)] border border-[rgba(255,255,255,0.1)] rounded-lg cursor-pointer hover:border-[rgba(6,182,212,0.3)] transition-all';
                item.onclick = () => loadFromHistory(index);
                
                const date = new Date(entry.timestamp);
                const timeStr = date.toLocaleString('en-US', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                item.innerHTML = `
                    <div class="text-xs text-gray-500 mb-1">${timeStr}</div>
                    <div class="text-sm font-medium mb-2 text-gray-200 line-clamp-2">${entry.prompt}</div>
                    <div class="flex flex-wrap gap-2 text-xs text-gray-400">
                        <span>Seed: ${entry.seed}</span>
                        <span>${entry.resolution}</span>
                        <span>${entry.steps} Steps</span>
                        <span>CFG ${entry.cfg}</span>
                    </div>
                `;
                
                container.appendChild(item);
            });
        }

        function loadFromHistory(index) {
            const entry = promptHistory[index];
            
            document.getElementById('promptInput').value = entry.prompt;
            document.getElementById('negativePromptInput').value = entry.negativePrompt;
            document.getElementById('seedInput').value = entry.seed;
            document.getElementById('resSelect').value = entry.resolution;
            document.getElementById('stepsSlider').value = entry.steps;
            document.getElementById('stepsValue').textContent = entry.steps;
            document.getElementById('cfgSlider').value = entry.cfg;
            document.getElementById('cfgValue').textContent = entry.cfg;
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function clearPromptHistory() {
            if (confirm('Do you want to clear the entire Prompt History?')) {
                promptHistory = [];
                localStorage.removeItem('iris_prompt_history');
                updatePromptHistoryUI();
            }
        }

        function showGenerationNotification(progress, step, total) {
            if (document.hidden && 'Notification' in window) {
                if (Notification.permission === 'granted') {
                    if (!generationNotification) {
                        generationNotification = new Notification('I.R.I.S. Generation', {
                            body: `Progress: ${progress}% (${step}/${total})`,
                            icon: '/static/assets/favicon.png',
                            tag: 'generation',
                            requireInteraction: false
                        });
                    } else {
                        generationNotification.close();
                        generationNotification = new Notification('I.R.I.S. Generation', {
                            body: `Progress: ${progress}% (${step}/${total})`,
                            icon: '/static/assets/favicon.png',
                            tag: 'generation',
                            requireInteraction: false
                        });
                    }
                } else if (Notification.permission !== 'denied') {
                    Notification.requestPermission();
                }
            }
            
            if (document.hidden) {
                document.title = `[${progress}%] I.R.I.S. Generating...`;
            }
        }

        function showCompletedNotification(imageSrc) {
            if (document.hidden && 'Notification' in window && Notification.permission === 'granted') {
                if (generationNotification) {
                    generationNotification.close();
                }
                
                const notification = new Notification('Generation Complete!', {
                    body: 'Click here to view your image',
                    icon: '/static/assets/favicon.png',
                    tag: 'completed',
                    requireInteraction: true,
                    image: imageSrc
                });
                
                notification.onclick = () => {
                    window.focus();
                    notification.close();
                };
            }
            
            document.title = 'I.R.I.S.';
            generationNotification = null;
        }

        function loadSavedSettings() {
            try {
                const saved = localStorage.getItem('iris_settings');
                if (saved) {
                    const settings = JSON.parse(saved);
                    if (settings.style) {
                        currentStyle = settings.style;
                        document.getElementById('styleSelect').value = settings.style;
                    }
                    if (settings.quality) {
                        document.getElementById('qualityPreset').value = settings.quality;
                        applyQualityPreset(settings.quality);
                    }
                    if (settings.resolution) {
                        document.getElementById('resSelect').value = settings.resolution;
                    }
                    if (settings.steps) {
                        document.getElementById('stepsSlider').value = settings.steps;
                        document.getElementById('stepsValue').textContent = settings.steps;
                    }
                    if (settings.cfg) {
                        document.getElementById('cfgSlider').value = settings.cfg;
                        document.getElementById('cfgValue').textContent = settings.cfg;
                    }
                    if (settings.negativePrompt) {
                        document.getElementById('negativePromptInput').value = settings.negativePrompt;
                    }
                }
            } catch (error) {
                console.error('Failed to load settings:', error);
            }
            
            loadPromptHistory();
            checkResolutionWarning(); // Initial check
        }

        function saveSettings() {
            try {
                const settings = {
                    style: currentStyle,
                    quality: document.getElementById('qualityPreset').value,
                    resolution: document.getElementById('resSelect').value,
                    steps: parseInt(document.getElementById('stepsSlider').value),
                    cfg: parseFloat(document.getElementById('cfgSlider').value),
                    negativePrompt: document.getElementById('negativePromptInput').value
                };
                localStorage.setItem('iris_settings', JSON.stringify(settings));
            } catch (error) {
                console.error('Failed to save settings:', error);
            }
        }

        function showDetailedError(errorType, errorMessage) {
            const errorMap = {
                'connection': {
                    title: 'Connection Failed',
                    message: 'Cannot connect to the backend server.',
                    solutions: [
                        'Make sure the server is running: python src/start.py web',
                        'Check if port 8000 is available',
                        'Verify your firewall settings',
                        'Try restarting the server'
                    ]
                },
                'cuda_oom': {
                    title: 'Out of Memory (CUDA OOM)',
                    message: 'Your GPU ran out of VRAM during generation.',
                    solutions: [
                        'Use smaller resolution (512x512 recommended)',
                        'Reduce steps to 20-25',
                        'Select "Fast" quality preset',
                        'Enable DRAM Extension in Settings',
                        'Generate at low res, then upscale'
                    ]
                },
                'timeout': {
                    title: 'Generation Timeout',
                    message: 'Generation took too long and was cancelled.',
                    solutions: [
                        'Use faster quality presets',
                        'Reduce resolution',
                        'Check if GPU is overheating',
                        'Close other GPU-intensive applications'
                    ]
                },
                'model_error': {
                    title: 'Model Error',
                    message: 'There was an error with the AI model.',
                    solutions: [
                        'Restart the server',
                        'Check console for detailed error logs',
                        'Verify model files are downloaded correctly'
                    ]
                },
                'websocket_closed': {
                    title: 'Connection Lost',
                    message: 'WebSocket connection was closed unexpectedly.',
                    solutions: [
                        'Check your network connection',
                        'Server might have crashed - check terminal',
                        'Try refreshing the page',
                        'Restart the backend server'
                    ]
                },
                'generic': {
                    title: 'Error Occurred',
                    message: errorMessage || 'An unknown error occurred.',
                    solutions: [
                        'Check the browser console (F12) for details',
                        'Check the server terminal for errors',
                        'Try refreshing the page',
                        'Restart the server if issues persist'
                    ]
                }
            };

            const error = errorMap[errorType] || errorMap['generic'];
            const solutionsText = error.solutions.map(s => '- ' + s).join('\n');
            alert(`${error.title}\n\n${error.message}\n\nSolutions:\n${solutionsText}`);
        }

        function setStyle(style) {
            currentStyle = style;
            console.log(`Style changed to: ${style}`);
            saveSettings();
        }

        function toggleSeedLock() {
            seedLocked = !seedLocked;
            const seedInput = document.getElementById('seedInput');
            const lockBtn = document.getElementById('seedLockBtn');
            
            if (seedLocked) {
                seedInput.readOnly = true;
                seedInput.style.background = 'rgba(6, 182, 212, 0.1)';
                lockBtn.textContent = 'Locked';
            } else {
                seedInput.readOnly = false;
                seedInput.style.background = '';
                lockBtn.textContent = 'Unlocked';
            }
        }

        function randomSeed() {
            if (!seedLocked) {
                document.getElementById('seedInput').value = Math.floor(Math.random() * 100000);
            }
        }

        function randomPrompt() {
            const prompts = [
                "anime girl with pastel pink hair, cat ears, magical staff, starry night",
                "cyberpunk character with neon blue hair, tech armor, futuristic city",
                "fantasy elf with silver hair, pointed ears, mystical forest",
                "cute chibi character with oversized hoodie, animal tail, kawaii",
                "warrior girl with red hair, sword, battle armor, dramatic pose",
                "maid outfit, twin tails, holding tea tray, elegant mansion",
                "school uniform, shy smile, cherry blossoms, spring day",
                "gothic lolita, black dress, red ribbons, vampire aesthetic",
                "steampunk engineer with goggles, mechanical wings, brass clockwork",
                "magical girl transformation, rainbow sparkles, flowing ribbons",
                "ninja assassin in moonlight, katana, dark rooftops",
                "angel with white wings, golden halo, heavenly clouds",
                "demon girl with horns, tail, mysterious smile, dark flames",
                "futuristic pilot in astronaut suit, alien planet landscape",
                "underwater mermaid with flowing hair, colorful fish, coral reef"
            ];
            document.getElementById('promptInput').value = prompts[Math.floor(Math.random() * prompts.length)];
        }

        function useLastPrompt() {
            if (lastPrompt) {
                document.getElementById('promptInput').value = lastPrompt;
            } else {
                alert('No previous prompt available');
            }
        }

        function applyQualityPreset(preset) {
            const presets = {
                'fast': { steps: 20, cfg: 7 },
                'medium': { steps: 28, cfg: 8.5 },
                'balanced': { steps: 35, cfg: 10 },
                'quality': { steps: 50, cfg: 12 },
                'high': { steps: 75, cfg: 13 },
                'extreme': { steps: 100, cfg: 14 },
                'ultra': { steps: 150, cfg: 15 }
            };
            const p = presets[preset];
            document.getElementById('stepsSlider').value = p.steps;
            document.getElementById('stepsValue').textContent = p.steps;
            document.getElementById('cfgSlider').value = p.cfg;
            document.getElementById('cfgValue').textContent = p.cfg;
            
            saveSettings();
            checkResolutionWarning();
        }

        function handleResolutionChange() {
            const resSelect = document.getElementById('resSelect');
            const customResContainer = document.getElementById('customResContainer');
            const resolutionWarning = document.getElementById('resolutionWarning');
            
            if (resSelect.value === 'custom') {
                customResContainer.style.display = 'block';
                // Also clear the selected value to prevent conflicts if user switches back and forth
                resSelect.value = 'custom'; 
            } else {
                customResContainer.style.display = 'none';
                checkResolutionWarning();
            }
        }
        
        function checkResolutionWarning() {
            const resSelect = document.getElementById('resSelect');
            const resolutionWarning = document.getElementById('resolutionWarning');
            const resolution = resSelect.value;
            
            // Show warning for high resolutions
            if (resolution.includes('1536') || resolution.includes('2048') || 
                resolution.includes('2560') || resolution.includes('3072') || 
                resolution.includes('4096')) {
                resolutionWarning.style.display = 'block';
            } else {
                resolutionWarning.style.display = 'none';
            }
        }

        // Removed PIP related functions: showPip, closePip, goToGenerator

        function updateProgress(data) {
            if (generationActive) {
                document.getElementById('progressText').textContent = data.message || 'Generating...';
                document.getElementById('progressPercent').textContent = data.progress + '%';
                document.getElementById('progressBar').style.width = data.progress + '%';
                const eta = data.eta;
                const etaMin = Math.floor(eta / 60);
                const etaSec = Math.floor(eta % 60);
                document.getElementById('etaText').textContent = `Estimated time: ${etaMin}m ${etaSec}s`;
                showGenerationNotification(Math.floor(data.progress), data.step, data.total_steps);
            }
        }

        function handleCompletion(data) {
            lastPrompt = document.getElementById('promptInput').value; // Ensure lastPrompt is updated
            const steps = parseInt(document.getElementById('stepsSlider').value);
            const cfg = parseFloat(document.getElementById('cfgSlider').value);
            const negativePrompt = document.getElementById('negativePromptInput').value;
            
            const resSelect = document.getElementById('resSelect');
            let width, height;
            if (resSelect.value === 'custom') {
                width = parseInt(document.getElementById('customWidth').value);
                height = parseInt(document.getElementById('customHeight').value);
            } else {
                [width, height] = resSelect.value.split('x').map(Number);
            }
            
            saveToPromptHistory(lastPrompt, negativePrompt, data.seed, width, height, steps, cfg);
            
            showCompletedNotification(data.image);
            
            finishGeneration(data);
            if (ws) {
                ws.close();
                ws = null;
            }
            generationActive = false;
        }

        function handleError(data) {
            const errorMessage = data.message || 'Unknown error occurred';
            
            if (errorMessage.includes('CUDA') || errorMessage.includes('out of memory') || errorMessage.includes('OOM')) {
                showDetailedError('cuda_oom', errorMessage);
            } else if (errorMessage.includes('timeout')) {
                showDetailedError('timeout', errorMessage);
            } else if (errorMessage.includes('model')) {
                showDetailedError('model_error', errorMessage);
            } else {
                showDetailedError('generic', errorMessage);
            }
            
            resetUI();
            if (ws) {
                ws.close();
                ws = null;
            }
            generationActive = false;
        }

        async function generateImage() {
            if (generating) return;
            
            if (ws && ws.readyState !== WebSocket.CLOSED) {
                ws.close();
                ws = null;
            }
            
            let width, height;
            const resSelect = document.getElementById('resSelect');
            if (resSelect.value === 'custom') {
                width = parseInt(document.getElementById('customWidth').value);
                height = parseInt(document.getElementById('customHeight').value);
                
                if (!width || !height || width < 256 || height < 256 || width > 4096 || height > 4096) {
                    alert('Please enter valid custom dimensions (256-4096 pixels)');
                    return;
                }
            } else {
                [width, height] = resSelect.value.split('x').map(Number);
            }
            
            const megapixels = (width * height) / 1000000;
            
            if (megapixels > 4) {
                const confirmed = confirm(
                    `⚠️ EXTREME RESOLUTION WARNING ⚠️\n\n` +
                    `Resolution: ${resSelect.value} (${megapixels.toFixed(1)} MP)\n\n` +
                    `This may:\n` +
                    `• Require 12GB+ VRAM (24GB+ for 4K)\n` +
                    `• Take 5-15+ minutes to generate\n` +
                    `• Cause out-of-memory errors\n\n` +
                    `Recommendation: Use 512x768 or 768x768 with Upscale instead.\n\n` +
                    'Continue anyway?'
                );
                if (!confirmed) return;
            } else if (megapixels > 0.75) {
                const confirmed = confirm(
                    `WARNING: This resolution (${resSelect.value}) may take significantly longer!\n\n` +
                    `Recommended: Use a lower resolution with Upscale after generation.\n\n` +
                    'Continue anyway?'
                );
                if (!confirmed) return;
            }
            
            saveSettings();
            
            generating = true;
            generationActive = true;
            const btn = document.getElementById('generateBtn');
            btn.disabled = true;
            document.getElementById('gpuStatusDot').classList.add('warning');
            document.getElementById('gpuStatusText').textContent = 'Generating';
            
            document.getElementById('placeholderText').classList.add('hidden');
            document.getElementById('progressContainer').classList.remove('hidden');
            document.getElementById('previewArea').classList.add('generating');
            
            const prompt = document.getElementById('promptInput').value;
            lastPrompt = prompt;
            
            let seed = null;
            if (seedLocked) {
                const seedInput = document.getElementById('seedInput').value;
                seed = seedInput ? parseInt(seedInput) : Math.floor(Math.random() * 100000);
            } else {
                seed = document.getElementById('seedInput').value ? parseInt(document.getElementById('seedInput').value) : null;
            }
            
            const steps = parseInt(document.getElementById('stepsSlider').value);
            const cfg = parseFloat(document.getElementById('cfgSlider').value);
            const negativePrompt = document.getElementById('negativePromptInput').value;
            
            const settings = {
                prompt: prompt,
                negative_prompt: negativePrompt,
                style: currentStyle,
                seed: seed,
                steps: steps,
                cfg_scale: cfg,
                width: width,
                height: height
            };
            
            // Save prompt history only if seed is set, otherwise it's truly random
            if (seed) {
                saveToPromptHistory(prompt, negativePrompt, seed, width, height, steps, cfg);
            }
            
            try {
                ws = new WebSocket(WS_URL);
                
                ws.onopen = () => {
                    ws.send(JSON.stringify(settings));
                };
                
                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'progress') {
                        updateProgress(data);
                    } else if (data.type === 'completed') {
                        handleCompletion(data);
                    } else if (data.type === 'error') {
                        handleError(data);
                    }
                };
                
                ws.onerror = (error) => {
                    showDetailedError('connection', error.message);
                    resetUI();
                    if (ws) {
                        ws.close();
                        ws = null;
                    }
                };
                
                ws.onclose = (event) => {
                    if (generating) {
                        if (event.code !== 1000) {
                            showDetailedError('websocket_closed', event.reason);
                        }
                        resetUI();
                    }
                    ws = null;
                };
                
            } catch (error) {
                showDetailedError('connection', error.message);
                resetUI();
                ws = null;
            }
        }

        function resetUI() {
            generating = false;
            generationActive = false;
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('gpuStatusDot').classList.remove('warning');
            document.getElementById('gpuStatusText').textContent = 'Ready';
            document.getElementById('previewArea').classList.remove('generating');
            document.getElementById('progressContainer').classList.add('hidden');
            document.getElementById('imageActions').classList.add('hidden');
            document.getElementById('upscaleOptions').classList.add('hidden');
        }

        function finishGeneration(data) {
            currentImageData = data;
            document.getElementById('progressContainer').classList.add('hidden');
            document.getElementById('previewImage').classList.remove('hidden');
            document.getElementById('previewImage').src = data.image;
            document.getElementById('previewImage').dataset.filename = data.filename;
            document.getElementById('previewImage').dataset.prompt = lastPrompt;
            document.getElementById('previewImage').dataset.seed = data.seed;
            document.getElementById('imageActions').classList.remove('hidden');
            document.getElementById('previewArea').classList.remove('generating');
            
            imageCounter++;
            document.getElementById('imageCount').textContent = imageCounter;
            
            const genTime = data.generation_time;
            const min = Math.floor(genTime / 60);
            const sec = Math.floor(genTime % 60);
            const timeStr = min > 0 ? `${min}m ${sec}s` : `${sec}s`;
            
            document.getElementById('imageInfo').textContent = `Seed: ${data.seed} | ${timeStr}`;
            
            if (data.seed && !seedLocked) {
                document.getElementById('seedInput').value = data.seed;
            }
            
            resetUI();
            document.getElementById('imageActions').classList.remove('hidden');
            addToGallery(data.image, data.filename, lastPrompt, data.seed);
            refreshOutputGallery();
        }

        function addToGallery(imageSrc, filename, prompt, seed) {
            const gallery = document.getElementById('gallery');
            
            while (gallery.children.length >= 12) {
                gallery.removeChild(gallery.lastChild);
            }
            
            const container = document.createElement('div');
            container.className = 'gallery-item';
            container.onclick = () => showImage(imageSrc, filename, prompt, seed);
            
            const img = document.createElement('img');
            img.src = imageSrc;
            img.alt = prompt;
            
            container.appendChild(img);
            gallery.prepend(container);
        }

        function showImage(src, filename, prompt, seed) {
            const img = document.getElementById('previewImage');
            img.src = src;
            img.dataset.filename = filename;
            img.dataset.prompt = prompt;
            img.dataset.seed = seed;
            img.classList.remove('hidden');
            
            document.getElementById('placeholderText').classList.add('hidden');
            document.getElementById('imageActions').classList.remove('hidden');
            document.getElementById('imageInfo').textContent = `Seed: ${seed}`;
            
            currentImageData = { image: src, filename: filename, seed: seed };
        }

        function downloadImage() {
            const img = document.getElementById('previewImage');
            const link = document.createElement('a');
            link.href = img.src;
            link.download = img.dataset.filename || 'generated_image.png';
            link.click();
        }

        async function upscaleImage() {
            if (!currentImageData) {
                alert('Generate an image first!');
                return;
            }
            
            const btn = document.getElementById('upscaleBtn');
            btn.disabled = true;
            btn.textContent = `Upscaling ${selectedUpscaleScale}x...`;
            
            try {
                const response = await fetch(API_URL + '/upscale', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filename: currentImageData.filename,
                        scale: selectedUpscaleScale
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('previewImage').src = data.image;
                    document.getElementById('imageInfo').textContent = `Upscaled ${data.scale}x: ${data.width}x${data.height} (${data.method})`;
                    currentImageData.filename = data.filename;
                    addToGallery(data.image, data.filename, lastPrompt, currentImageData.seed);
                    alert(`Upscaled ${data.scale}x successfully using ${data.method}!`);
                } else {
                    showDetailedError('generic', data.error);
                }
            } catch (error) {
                showDetailedError('connection', error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Upscale';
                document.getElementById('upscaleOptions').classList.add('hidden');
            }
        }

        async function createVariation() {
            if (!currentImageData) {
                alert('Generate an image first!');
                return;
            }
            
            const strength = prompt('Enter variation strength (0.1-0.9):', '0.5');
            if (!strength) return;
            
            alert('Creating variation... This will take 1-2 minutes!');
            
            try {
                const response = await fetch(API_URL + '/variation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filename: currentImageData.filename,
                        strength: parseFloat(strength),
                        prompt: document.getElementById('promptInput').value,
                        seed: currentImageData.seed
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('previewImage').src = data.image;
                    currentImageData = { ...currentImageData, ...data };
                    addToGallery(data.image, data.filename, lastPrompt, data.seed);
                    alert('Variation created!');
                } else {
                    showDetailedError('generic', data.error);
                }
            } catch (error) {
                showDetailedError('connection', error.message);
            }
        }

        function img2img() {
            alert('Image-to-Image editing coming soon!');
        }

        async function refreshOutputGallery() {
            try {
                const response = await fetch(API_URL + '/output-gallery');
                const data = await response.json();
                
                const gallery = document.getElementById('outputGallery');
                
                if (data.images.length === 0) {
                    gallery.innerHTML = '<div class="col-span-full text-center py-8 text-gray-400">No images yet</div>';
                    return;
                }
                
                gallery.innerHTML = '';
                
                data.images.forEach(filename => {
                    const container = document.createElement('div');
                    container.className = 'gallery-item';
                    
                    const img = document.createElement('img');
                    img.src = API_URL + `/output-image/${filename}`;
                    img.alt = filename;
                    img.onclick = () => showOutputImage(filename);
                    
                    container.appendChild(img);
                    gallery.appendChild(container);
                });
                
            } catch (error) {
                document.getElementById('outputGallery').innerHTML = 
                    '<div class="col-span-full text-center py-8 text-red-400">Failed to load images</div>';
            }
        }

        function showOutputImage(filename) {
            const imgUrl = API_URL + `/output-image/${filename}`;
            showImage(imgUrl, filename, '', '');
            currentImageData = { filename: filename };
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey && document.activeElement.tagName !== 'TEXTAREA') {
                if (!generating) generateImage();
            }
            
            if (e.key === 'Escape' && generating && ws) {
                if (confirm('Cancel current generation?')) {
                    ws.close();
                    resetUI();
                }
            }
            
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveSettings();
                alert('Settings saved!');
            }
        });

        ['qualityPreset', 'resSelect', 'stepsSlider', 'cfgSlider', 'styleSelect'].forEach(id => {
            document.getElementById(id).addEventListener('change', saveSettings);
        });

        // Initialize
        randomSeed();
        loadSavedSettings();
        refreshOutputGallery();
        
        // Removed PIP related event listeners and logic
        
        const galleryLink = document.querySelector('a[href="/gallery"]');
        if (galleryLink) {
            galleryLink.addEventListener('click', function(e) {
                if (generationActive) {
                    e.preventDefault();
                    window.open('/gallery', '_blank');
                }
            });
        }

        window.addEventListener('DOMContentLoaded', () => {
            loadSavedSettings();
            refreshOutputGallery();
            
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        });
    </script>
</body>
</html>
